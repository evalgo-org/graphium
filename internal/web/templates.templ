package web

import (
	"fmt"
	"time"
	"evalgo.org/graphium/models"
	"evalgo.org/graphium/internal/storage"
)

// Base layout template (for backward compatibility - no user param)
templ Layout(title string) {
	@LayoutWithUser(title, nil)
}

// Base layout template with optional user parameter
templ LayoutWithUser(title string, user *models.User) {
	<!DOCTYPE html>
	<html lang="en">
	<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<title>{ title } - Graphium</title>
		<script src="https://unpkg.com/htmx.org@1.9.10"></script>
		<script src="https://unpkg.com/htmx.org/dist/ext/ws.js"></script>
		<link rel="stylesheet" href="/static/css/styles.css"/>
	</head>
	<body>
		<nav class="navbar">
			<div class="nav-brand">
				<h1>üß¨ Graphium</h1>
				<p class="tagline">Container Intelligence Platform</p>
			</div>
			<ul class="nav-links">
				<li><a href="/" class="nav-link">Dashboard</a></li>
				<li><a href="/web/containers" class="nav-link">Containers</a></li>
				<li><a href="/web/hosts" class="nav-link">Hosts</a></li>
				<li><a href="/web/agents" class="nav-link">Agents</a></li>
				<li><a href="/web/stacks" class="nav-link">Stacks</a></li>
				<li><a href="/web/topology" class="nav-link">Topology</a></li>
			</ul>
			<div class="nav-user">
				if user != nil {
					<span class="user-name">üë§ { user.Username }</span>
					if user.IsAdmin() {
						<a href="/web/users" class="nav-link">Users</a>
					}
					<a href="/web/profile" class="nav-link">Profile</a>
					<a href="/web/auth/logout" class="nav-link">Logout</a>
				} else {
					<a href="/web/auth/login" class="nav-link">Login</a>
				}
			</div>
		</nav>
		<main class="container">
			{ children... }
		</main>
		<footer class="footer">
			<p>Graphium - Semantic Container Orchestration</p>
		</footer>

		<!-- Confirmation Modal -->
		<div id="confirmModal" class="modal" style="display: none;">
			<div class="modal-content">
				<div class="modal-header">
					<h3 id="confirmModalTitle">Confirm Action</h3>
				</div>
				<div class="modal-body">
					<p id="confirmModalMessage"></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
					<button type="button" class="btn btn-danger" id="confirmModalButton">Delete</button>
				</div>
			</div>
		</div>

		<!-- Theme Toggle Button -->
		<button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
			<span class="sun-icon">‚òÄÔ∏è</span>
			<span class="moon-icon">üåô</span>
		</button>

		<script>
			// Confirmation Modal Functions
			let confirmCallback = null;

			function showConfirmModal(title, message, buttonText, callback) {
				document.getElementById('confirmModalTitle').textContent = title;
				document.getElementById('confirmModalMessage').textContent = message;
				document.getElementById('confirmModalButton').textContent = buttonText || 'Delete';
				confirmCallback = callback;
				document.getElementById('confirmModal').style.display = 'flex';
			}

			function closeConfirmModal() {
				document.getElementById('confirmModal').style.display = 'none';
				confirmCallback = null;
			}

			document.getElementById('confirmModalButton').addEventListener('click', function() {
				if (confirmCallback) {
					confirmCallback();
				}
				closeConfirmModal();
			});

			// Close modal on background click
			document.getElementById('confirmModal').addEventListener('click', function(e) {
				if (e.target === this) {
					closeConfirmModal();
				}
			});
		</script>

		<script>
			// Theme toggle functionality
			(function() {
				const themeToggle = document.getElementById('themeToggle');
				const htmlElement = document.documentElement;

				// Check for saved theme preference or default to 'dark'
				const currentTheme = localStorage.getItem('theme') || 'dark';
				if (currentTheme === 'light') {
					htmlElement.setAttribute('data-theme', 'light');
				}

				// Toggle theme on button click
				themeToggle.addEventListener('click', function() {
					const theme = htmlElement.getAttribute('data-theme');
					if (theme === 'light') {
						htmlElement.removeAttribute('data-theme');
						localStorage.setItem('theme', 'dark');
					} else {
						htmlElement.setAttribute('data-theme', 'light');
						localStorage.setItem('theme', 'light');
					}
				});
			})();
		</script>
	</body>
	</html>
}

// Dashboard template (with user)
templ DashboardWithUser(stats *storage.Statistics, user *models.User) {
	@LayoutWithUser("Dashboard", user) {
		<div class="dashboard">
			<h2>Infrastructure Overview</h2>

			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-icon">üì¶</div>
					<div class="stat-content">
						<h3>Total Containers</h3>
						<p class="stat-value" id="stat-total-containers">{ fmt.Sprintf("%d", stats.TotalContainers) }</p>
					</div>
				</div>

				<div class="stat-card stat-success">
					<div class="stat-icon">‚ñ∂Ô∏è</div>
					<div class="stat-content">
						<h3>Running</h3>
						<p class="stat-value" id="stat-running-containers">{ fmt.Sprintf("%d", stats.RunningContainers) }</p>
					</div>
				</div>

				<div class="stat-card">
					<div class="stat-icon">üñ•Ô∏è</div>
					<div class="stat-content">
						<h3>Total Hosts</h3>
						<p class="stat-value" id="stat-total-hosts">{ fmt.Sprintf("%d", stats.TotalHosts) }</p>
					</div>
				</div>

				<div class="stat-card">
					<div class="stat-icon">üìö</div>
					<div class="stat-content">
						<h3>Total Stacks</h3>
						<p class="stat-value" id="stat-total-stacks">{ fmt.Sprintf("%d", stats.TotalStacks) }</p>
					</div>
				</div>

				<div class="stat-card stat-success">
					<div class="stat-icon">üöÄ</div>
					<div class="stat-content">
						<h3>Running Stacks</h3>
						<p class="stat-value" id="stat-running-stacks">{ fmt.Sprintf("%d", stats.RunningStacks) }</p>
					</div>
				</div>

				<div class="stat-card stat-info">
					<div class="stat-icon">üìä</div>
					<div class="stat-content">
						<h3>Hosts with Containers</h3>
						<p class="stat-value" id="stat-hosts-with-containers">{ fmt.Sprintf("%d", len(stats.HostContainerCounts)) }</p>
					</div>
				</div>

				<div class="stat-card">
					<div class="stat-icon">ü§ñ</div>
					<div class="stat-content">
						<h3>Total Agents</h3>
						<p class="stat-value" id="stat-total-agents">{ fmt.Sprintf("%d", stats.TotalAgents) }</p>
					</div>
				</div>

				<div class="stat-card stat-success">
					<div class="stat-icon">‚úÖ</div>
					<div class="stat-content">
						<h3>Running Agents</h3>
						<p class="stat-value" id="stat-running-agents">{ fmt.Sprintf("%d", stats.RunningAgents) }</p>
					</div>
				</div>
			</div>



		</div>
		<script>
			(function() {
				// WebSocket connection for real-time dashboard updates
				let ws = null;
				let wsReconnectAttempts = 0;
				const maxReconnectAttempts = 10;
				const reconnectDelay = 3000;

				function connectWebSocket() {
					const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
					const wsURL = `${protocol}//${window.location.host}/api/v1/ws/graph`;

					try {
						ws = new WebSocket(wsURL);

						ws.onopen = function() {
							console.log('Dashboard WebSocket connected');
							wsReconnectAttempts = 0;
						};

						ws.onmessage = function(event) {
							try {
								const graphEvent = JSON.parse(event.data);
								console.log('Dashboard received event:', graphEvent.type);

								// Refresh stats on any container/host/stack change
								if (graphEvent.type === 'container_added' ||
									graphEvent.type === 'container_removed' ||
									graphEvent.type === 'container_updated' ||
									graphEvent.type === 'host_added' ||
									graphEvent.type === 'host_removed' ||
									graphEvent.type === 'stack_added' ||
									graphEvent.type === 'stack_removed') {
									refreshStats();
								}
							} catch (error) {
								console.error('Failed to parse WebSocket message:', error);
							}
						};

						ws.onerror = function(error) {
							console.error('Dashboard WebSocket error:', error);
						};

						ws.onclose = function() {
							console.log('Dashboard WebSocket disconnected');
							// Attempt to reconnect
							if (wsReconnectAttempts < maxReconnectAttempts) {
								wsReconnectAttempts++;
								console.log(`Reconnecting dashboard WebSocket (attempt ${wsReconnectAttempts}/${maxReconnectAttempts})...`);
								setTimeout(connectWebSocket, reconnectDelay);
							} else {
								console.error('Max dashboard WebSocket reconnection attempts reached');
							}
						};
					} catch (error) {
						console.error('Failed to create dashboard WebSocket connection:', error);
					}
				}

				// Fetch and update statistics
				function refreshStats() {
					console.log('üîÑ Refreshing stats from /api/v1/stats...');
					fetch('/api/v1/stats', {
						credentials: 'same-origin'
					})
						.then(response => {
							console.log('üìä Stats API response status:', response.status);
							if (!response.ok) {
								throw new Error(`HTTP ${response.status}: ${response.statusText}`);
							}
							return response.json();
						})
						.then(data => {
							console.log('‚úÖ Stats data received:', data);
							document.getElementById('stat-total-containers').textContent = data.totalContainers;
							document.getElementById('stat-running-containers').textContent = data.runningContainers;
							document.getElementById('stat-total-hosts').textContent = data.totalHosts;
							document.getElementById('stat-total-stacks').textContent = data.totalStacks || 0;
							document.getElementById('stat-running-stacks').textContent = data.runningStacks || 0;
							document.getElementById('stat-total-agents').textContent = data.totalAgents || 0;
							document.getElementById('stat-running-agents').textContent = data.runningAgents || 0;
							document.getElementById('stat-hosts-with-containers').textContent = data.hostsWithContainers || 0;
							console.log('‚úÖ Dashboard DOM updated with new stats');
						})
						.catch(error => {
							console.error('‚ùå Failed to refresh stats:', error);
						});
				}

				// Connect WebSocket on page load
				connectWebSocket();

				// Also refresh stats immediately on page load (in case data changed while on another page)
				refreshStats();
			})();
		</script>
	}
}

// Pagination component
templ Pagination(pagination PaginationInfo, baseURL string, queryParams string) {
	<div class="pagination">
		<div class="pagination-info">
			Showing { fmt.Sprintf("%d-%d", (pagination.Page-1)*pagination.PageSize+1, min((pagination.Page-1)*pagination.PageSize+pagination.PageSize, pagination.TotalItems)) } of { fmt.Sprintf("%d", pagination.TotalItems) }
		</div>
		<div class="pagination-controls">
			if pagination.HasPrev {
				if queryParams != "" {
					<a href={ templ.URL(fmt.Sprintf("%s?%s&page=%d", baseURL, queryParams, pagination.Page-1)) } class="btn btn-secondary">‚Üê Previous</a>
				} else {
					<a href={ templ.URL(fmt.Sprintf("%s?page=%d", baseURL, pagination.Page-1)) } class="btn btn-secondary">‚Üê Previous</a>
				}
			} else {
				<span class="btn btn-secondary disabled">‚Üê Previous</span>
			}
			<span class="pagination-current">Page { fmt.Sprintf("%d", pagination.Page) } of { fmt.Sprintf("%d", pagination.TotalPages) }</span>
			if pagination.HasNext {
				if queryParams != "" {
					<a href={ templ.URL(fmt.Sprintf("%s?%s&page=%d", baseURL, queryParams, pagination.Page+1)) } class="btn btn-secondary">Next ‚Üí</a>
				} else {
					<a href={ templ.URL(fmt.Sprintf("%s?page=%d", baseURL, pagination.Page+1)) } class="btn btn-secondary">Next ‚Üí</a>
				}
			} else {
				<span class="btn btn-secondary disabled">Next ‚Üí</span>
			}
		</div>
	</div>
}

// Containers list template (with user)
templ ContainersListWithUser(containers []*models.Container, stackMap map[string]*models.Stack, pagination PaginationInfo, errorMsg string, user *models.User) {
	@LayoutWithUser("Containers", user) {
		if errorMsg != "" {
			<div class="alert alert-error" style="margin: 20px; padding: 15px; background-color: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c00;">
				{ errorMsg }
			</div>
		}
		<div class="page-header">
			<h2>Containers</h2>
			<div class="filters">
				<div class="bulk-actions-left">
					<span id="selected-count" class="selected-count">0 selected</span>
					<select id="bulk-action-select" class="action-select">
						<option value="">Select action...</option>
						<option value="assign-stack">Assign to Stack</option>
						<option value="delete">Delete</option>
						<option value="stop">Stop</option>
						<option value="start">Start</option>
						<option value="restart">Restart</option>
					</select>
					<button onclick="executeBulkAction()" class="btn btn-primary">Execute</button>
					<button onclick="clearSelection()" class="btn btn-secondary">Clear</button>
				</div>
				<div class="bulk-actions-right">
					<input
						type="text"
						name="search"
						class="search-input"
						placeholder="Search by name..."
						hx-get="/web/containers/table"
						hx-target="#containers-table"
						hx-trigger="keyup changed delay:300ms"
						hx-include="[name='status']"
					/>
					<select name="status" class="status-select" hx-get="/web/containers/table" hx-target="#containers-table" hx-trigger="change" hx-include="[name='search']">
						<option value="">All Statuses</option>
						<option value="running">Running</option>
						<option value="stopped">Stopped</option>
						<option value="paused">Paused</option>
						<option value="exited">Exited</option>
					</select>
				</div>
			</div>
		</div>

		<div id="containers-table">
			@ContainersTableWithPagination(containers, stackMap, pagination, "")
		</div>

		<!-- Confirmation Modal -->
		<div id="confirmModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3 class="modal-title" id="confirmModalTitle">Confirm Action</h3>
					<button class="modal-close" onclick="closeModal('confirmModal')">&times;</button>
				</div>
				<div class="modal-body" id="confirmModalBody"></div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
					<button class="btn btn-primary" id="confirmModalConfirm">Confirm</button>
				</div>
			</div>
		</div>

		<!-- Alert Modal -->
		<div id="alertModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3 class="modal-title" id="alertModalTitle">Notice</h3>
					<button class="modal-close" onclick="closeModal('alertModal')">&times;</button>
				</div>
				<div class="modal-body" id="alertModalBody"></div>
				<div class="modal-footer">
					<button class="btn btn-primary" onclick="closeModal('alertModal')">OK</button>
				</div>
			</div>
		</div>

		<!-- Assign to Stack Modal -->
		<div id="assignStackModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3 class="modal-title">Assign to Stack</h3>
					<button class="modal-close" onclick="closeModal('assignStackModal')">&times;</button>
				</div>
				<div class="modal-body">
					<p id="assign-stack-message"></p>
					<select id="stack-selector" class="action-select" style="width: 100%; margin-top: 1rem;">
						<option value="">Select a stack...</option>
					</select>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" onclick="closeModal('assignStackModal')">Cancel</button>
					<button class="btn btn-primary" id="assignStackConfirm">Assign</button>
				</div>
			</div>
		</div>

		<script>
			// Modal helper functions
			function showModal(modalId) {
				const modal = document.getElementById(modalId);
				if (modal) modal.classList.add('active');
			}

			function closeModal(modalId) {
				const modal = document.getElementById(modalId);
				if (modal) modal.classList.remove('active');
			}

			function showAlert(title, message, callback) {
				document.getElementById('alertModalTitle').textContent = title;
				document.getElementById('alertModalBody').innerHTML = message.replace(/\\n/g, '<br>');
				showModal('alertModal');
				const okBtn = document.querySelector('#alertModal .btn-primary');
				okBtn.onclick = function() {
					closeModal('alertModal');
					if (callback) callback();
				};
			}

			function showConfirm(title, message, onConfirm) {
				document.getElementById('confirmModalTitle').textContent = title;
				document.getElementById('confirmModalBody').innerHTML = message.replace(/\\n/g, '<br>');
				showModal('confirmModal');
				const confirmBtn = document.getElementById('confirmModalConfirm');
				confirmBtn.onclick = function() {
					closeModal('confirmModal');
					if (onConfirm) onConfirm();
				};
			}

			window.onclick = function(event) {
				if (event.target.classList.contains('modal')) {
					event.target.classList.remove('active');
				}
			};

			// Multi-select functionality for containers
			function toggleSelectAll(checkbox) {
				const checkboxes = document.querySelectorAll('.container-checkbox');
				checkboxes.forEach(cb => {
					cb.checked = checkbox.checked;
				});
				updateBulkActions();
			}

			function updateBulkActions() {
				const checkboxes = document.querySelectorAll('.container-checkbox:checked');
				const selectedCount = document.getElementById('selected-count');

				if (checkboxes.length > 0) {
					selectedCount.textContent = `${checkboxes.length} selected`;
				} else {
					selectedCount.textContent = '0 selected';
					// Reset dropdown
					const actionSelect = document.getElementById('bulk-action-select');
					if (actionSelect) {
						actionSelect.value = '';
					}
				}

				// Update "select all" checkbox state
				const allCheckboxes = document.querySelectorAll('.container-checkbox');
				const selectAllCheckbox = document.getElementById('select-all');
				if (selectAllCheckbox) {
					selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
				}
			}

			function clearSelection() {
				const checkboxes = document.querySelectorAll('.container-checkbox');
				checkboxes.forEach(cb => {
					cb.checked = false;
				});
				const selectAllCheckbox = document.getElementById('select-all');
				if (selectAllCheckbox) {
					selectAllCheckbox.checked = false;
				}
				updateBulkActions();
			}

			function getSelectedContainerIds() {
				const checkboxes = document.querySelectorAll('.container-checkbox:checked');
				return Array.from(checkboxes).map(cb => cb.dataset.containerId);
			}

			function executeBulkAction() {
				const actionSelect = document.getElementById('bulk-action-select');
				const action = actionSelect.value;

				if (!action) {
					showAlert('No Action Selected', 'Please select an action from the dropdown');
					return;
				}

				const containerIds = getSelectedContainerIds();
				if (containerIds.length === 0) {
					showAlert('No Containers Selected', 'Please select at least one container');
					return;
				}

				// Route to appropriate action handler
				switch (action) {
					case 'assign-stack':
						showAssignStackModal(containerIds);
						break;
					case 'delete':
						bulkDeleteContainers(containerIds);
						break;
					case 'stop':
						bulkStopContainers(containerIds);
						break;
					case 'start':
						bulkStartContainers(containerIds);
						break;
					case 'restart':
						bulkRestartContainers(containerIds);
						break;
					default:
						showAlert('Unknown Action', 'Unknown action: ' + action);
				}
			}

			function showAssignStackModal(containerIds) {
				const count = containerIds.length;
				document.getElementById('assign-stack-message').textContent = `Assign ${count} container${count > 1 ? 's' : ''} to a stack:`;

				// Fetch available stacks
				fetch('/web/stacks/json', {
					credentials: 'same-origin'
				})
				.then(response => {
					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`);
					}
					return response.json();
				})
				.then(stacks => {
					if (!Array.isArray(stacks)) {
						throw new Error('Invalid response format');
					}

					const selector = document.getElementById('stack-selector');
					selector.innerHTML = '<option value="">Select a stack...</option>';

					if (stacks.length === 0) {
						showAlert('No Stacks Available', 'Please create a stack first before assigning containers');
						return;
					}

					stacks.forEach(stack => {
						const option = document.createElement('option');
						option.value = stack.id;
						option.textContent = stack.name;
						selector.appendChild(option);
					});

					showModal('assignStackModal');

					document.getElementById('assignStackConfirm').onclick = function() {
						const stackId = selector.value;
						if (!stackId) {
							showAlert('No Stack Selected', 'Please select a stack');
							return;
						}
						assignContainersToStack(containerIds, stackId);
					};
				})
				.catch(error => {
					showAlert('Error', 'Failed to load stacks: ' + error.message);
				});
			}

			function assignContainersToStack(containerIds, stackId) {
				closeModal('assignStackModal');

				fetch(`/web/stacks/${stackId}/containers/assign`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ container_ids: containerIds }),
					credentials: 'same-origin'
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						showAlert('Success', `Successfully assigned ${data.count} container(s) to stack`, function() {
							window.location.reload();
						});
					} else {
						showAlert('Error', data.error || 'Failed to assign containers to stack');
					}
				})
				.catch(error => {
					showAlert('Error', 'Failed to assign containers: ' + error.message);
				});
			}

			function bulkDeleteContainers(containerIds) {
				const count = containerIds.length;
				const message = `Are you sure you want to delete ${count} container${count > 1 ? 's' : ''}?<br><br>This will:<br>- Remove the container(s) from Docker<br>- Remove the container(s) from the database<br><br>This action cannot be undone.`;

				showConfirm('Confirm Deletion', message, function() {
					performBulkAction('/web/containers/bulk/delete', { container_ids: containerIds }, 'Deleting', 'deleted');
				});
			}

			function bulkStopContainers(containerIds) {
				const count = containerIds.length;
				showConfirm('Confirm Stop', `Stop ${count} container${count > 1 ? 's' : ''}?`, function() {
					performBulkAction('/web/containers/bulk/stop', { container_ids: containerIds }, 'Stopping', 'stopped');
				});
			}

			function bulkStartContainers(containerIds) {
				const count = containerIds.length;
				showConfirm('Confirm Start', `Start ${count} container${count > 1 ? 's' : ''}?`, function() {
					performBulkAction('/web/containers/bulk/start', { container_ids: containerIds }, 'Starting', 'started');
				});
			}

			function bulkRestartContainers(containerIds) {
				const count = containerIds.length;
				showConfirm('Confirm Restart', `Restart ${count} container${count > 1 ? 's' : ''}?`, function() {
					performBulkAction('/web/containers/bulk/restart', { container_ids: containerIds }, 'Restarting', 'restarted');
				});
			}

			function performBulkAction(url, body, actioningText, actionedText) {
				const executeBtn = document.querySelector('.bulk-actions-left .btn-primary');
				const originalText = executeBtn.textContent;
				executeBtn.disabled = true;
				executeBtn.textContent = actioningText + '...';

				fetch(url, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(body),
					credentials: 'same-origin'
				})
				.then(response => response.json())
				.then(data => {
					executeBtn.disabled = false;
					executeBtn.textContent = originalText;

					if (data.success) {
						showAlert('Success', `Successfully ${actionedText} ${data.success_count || data.deleted_count || body.container_ids.length} container(s)`, function() {
							window.location.reload();
						});
					} else {
						const errorMsg = `Error: ${data.error}<br><br>Success: ${data.success_count || data.deleted_count || 0}<br>Failed: ${data.failed_count || 0}`;
						showAlert('Error', errorMsg, function() {
							window.location.reload();
						});
					}
				})
				.catch(error => {
					executeBtn.disabled = false;
					executeBtn.textContent = originalText;
					showAlert('Error', `Failed to ${actionedText.replace('ed', '')} containers: ${error.message}`);
				});
			}

			// Restore checkbox states after HTMX updates
			document.body.addEventListener('htmx:afterSwap', function(event) {
				if (event.detail.target.id === 'containers-table') {
					// Clear selections after table refresh
					clearSelection();
				}
			});
		</script>
	}
}

// Containers table component (for HTMX updates)
templ ContainersTable(containers []*models.Container, stackMap map[string]*models.Stack) {
	<div class="table-container">
		<table class="data-table">
			<thead>
				<tr>
					<th style="width: 40px;">
						<input type="checkbox" id="select-all" onclick="toggleSelectAll(this)" title="Select all" style="cursor: pointer; width: 16px; height: 16px;"/>
					</th>
					<th>Name</th>
					<th>Image</th>
					<th>Status</th>
					<th>Stack</th>
					<th>Host</th>
					<th>Created</th>
				</tr>
			</thead>
			<tbody>
				if len(containers) == 0 {
					<tr>
						<td colspan="7" class="no-data">No containers found</td>
					</tr>
				}
				for _, container := range containers {
					<tr>
						<td>
							<input
								type="checkbox"
								class="container-checkbox"
								data-container-id={ container.ID }
								data-container-name={ container.Name }
								data-container-status={ container.Status }
								onclick="updateBulkActions()"
								style="cursor: pointer; width: 16px; height: 16px;"
							/>
						</td>
						<td>
							<a href={ templ.URL(fmt.Sprintf("/web/containers/%s", container.ID)) } style="text-decoration: none; color: inherit;">
								<strong>{ container.Name }</strong>
							</a>
							<br/>
							<small class="text-muted">{ container.ID[:12] }</small>
						</td>
						<td>{ container.Image }</td>
						<td>
							<span class={ fmt.Sprintf("badge badge-%s", container.Status) }>
								{ container.Status }
							</span>
						</td>
						<td>
							if stackMap != nil {
								if stack, ok := stackMap[container.ID]; ok {
									<a href={ templ.URL(fmt.Sprintf("/web/stacks/%s", stack.ID)) } title={ fmt.Sprintf("Part of stack: %s", stack.Name) }>
										üì¶
									</a>
								} else {
									<span class="text-muted">-</span>
								}
							} else {
								<span class="text-muted">-</span>
							}
						</td>
						<td>{ container.HostedOn }</td>
						<td>{ container.Created }</td>
					</tr>
				}
			</tbody>
		</table>
		<div class="table-footer">
			<p>Total: { fmt.Sprintf("%d", len(containers)) } containers</p>
		</div>
	</div>
}

// Containers table with pagination (for HTMX updates)
templ ContainersTableWithPagination(containers []*models.Container, stackMap map[string]*models.Stack, pagination PaginationInfo, queryParams string) {
	<div class="table-container">
		<table class="data-table">
			<thead>
				<tr>
					<th style="width: 40px;">
						<input type="checkbox" id="select-all" onclick="toggleSelectAll(this)" title="Select all" style="cursor: pointer; width: 16px; height: 16px;"/>
					</th>
					<th>Name</th>
					<th>Image</th>
					<th>Status</th>
					<th>Stack</th>
					<th>Host</th>
					<th>Created</th>
				</tr>
			</thead>
			<tbody>
				if len(containers) == 0 {
					<tr>
						<td colspan="7" class="no-data">No containers found</td>
					</tr>
				}
				for _, container := range containers {
					<tr>
						<td>
							<input
								type="checkbox"
								class="container-checkbox"
								data-container-id={ container.ID }
								data-container-name={ container.Name }
								data-container-status={ container.Status }
								onclick="updateBulkActions()"
								style="cursor: pointer; width: 16px; height: 16px;"
							/>
						</td>
						<td>
							<a href={ templ.URL(fmt.Sprintf("/web/containers/%s", container.ID)) } style="text-decoration: none; color: inherit;">
								<strong>{ container.Name }</strong>
							</a>
							<br/>
							<small class="text-muted">{ container.ID[:12] }</small>
						</td>
						<td>{ container.Image }</td>
						<td>
							<span class={ fmt.Sprintf("badge badge-%s", container.Status) }>
								{ container.Status }
							</span>
						</td>
						<td>
							if stackMap != nil {
								if stack, ok := stackMap[container.ID]; ok {
									<a href={ templ.URL(fmt.Sprintf("/web/stacks/%s", stack.ID)) } title={ fmt.Sprintf("Part of stack: %s", stack.Name) }>
										üì¶
									</a>
								} else {
									<span class="text-muted">-</span>
								}
							} else {
								<span class="text-muted">-</span>
							}
						</td>
						<td>{ container.HostedOn }</td>
						<td>{ container.Created }</td>
					</tr>
				}
			</tbody>
		</table>
		@Pagination(pagination, "/web/containers", queryParams)
	</div>
}

// Hosts list template (with user)
templ HostsListWithUser(hosts []*models.Host, pagination PaginationInfo, user *models.User) {
	@LayoutWithUser("Hosts", user) {
		<div class="page-header">
			<h2>Hosts</h2>
			<div class="filters">
				<a href="/web/hosts/new" class="btn btn-primary">+ Create Host</a>
				<input
					type="text"
					name="search"
					class="search-input"
					placeholder="Search by name..."
					hx-get="/web/hosts/table"
					hx-target="#hosts-table"
					hx-trigger="keyup changed delay:300ms"
					hx-include="[name='status']"
				/>
				<select name="status" hx-get="/web/hosts/table" hx-target="#hosts-table" hx-trigger="change" hx-include="[name='search']">
					<option value="">All Statuses</option>
					<option value="active">Active</option>
					<option value="inactive">Inactive</option>
					<option value="maintenance">Maintenance</option>
				</select>
			</div>
		</div>

		<div id="hosts-table">
			@HostsTableWithPagination(hosts, pagination, "")
		</div>
	}
}

// Hosts table component (for HTMX updates)
templ HostsTable(hosts []*models.Host) {
	<div class="table-container">
		<table class="data-table">
			<thead>
				<tr>
					<th>Name</th>
					<th>IP Address</th>
					<th>CPU</th>
					<th>Memory</th>
					<th>Status</th>
					<th>Datacenter</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				if len(hosts) == 0 {
					<tr>
						<td colspan="7" class="no-data">No hosts found</td>
					</tr>
				}
				for _, host := range hosts {
					<tr>
						<td>
							<strong>{ host.Name }</strong>
							<br/>
							<small class="text-muted">{ host.ID }</small>
						</td>
						<td>{ host.IPAddress }</td>
						<td>{ fmt.Sprintf("%d cores", host.CPU) }</td>
						<td>{ fmt.Sprintf("%.1f GB", float64(host.Memory) / 1024 / 1024 / 1024) }</td>
						<td>
							<span class={ fmt.Sprintf("badge badge-%s", host.Status) }>
								{ host.Status }
							</span>
						</td>
						<td>{ host.Datacenter }</td>
						<td>
							<div class="action-buttons">
								<a href={ templ.URL(fmt.Sprintf("/web/hosts/%s", host.ID)) } class="btn-icon" title="View Details">üëÅÔ∏è</a>
								<a href={ templ.URL(fmt.Sprintf("/web/containers?host=%s", host.ID)) } class="btn-icon" title="View Containers">üì¶</a>
							</div>
						</td>
					</tr>
				}
			</tbody>
		</table>
		<div class="table-footer">
			<p>Total: { fmt.Sprintf("%d", len(hosts)) } hosts</p>
		</div>
	</div>
}

// Hosts table with pagination (for HTMX updates)
templ HostsTableWithPagination(hosts []*models.Host, pagination PaginationInfo, queryParams string) {
	<div class="table-container">
		<table class="data-table">
			<thead>
				<tr>
					<th>Name</th>
					<th>IP Address</th>
					<th>CPU</th>
					<th>Memory</th>
					<th>Status</th>
					<th>Datacenter</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				if len(hosts) == 0 {
					<tr>
						<td colspan="7" class="no-data">No hosts found</td>
					</tr>
				}
				for _, host := range hosts {
					<tr>
						<td>
							<strong>{ host.Name }</strong>
							<br/>
							<small class="text-muted">{ host.ID }</small>
						</td>
						<td>{ host.IPAddress }</td>
						<td>{ fmt.Sprintf("%d cores", host.CPU) }</td>
						<td>{ fmt.Sprintf("%.1f GB", float64(host.Memory) / 1024 / 1024 / 1024) }</td>
						<td>
							<span class={ fmt.Sprintf("badge badge-%s", host.Status) }>
								{ host.Status }
							</span>
						</td>
						<td>{ host.Datacenter }</td>
						<td>
							<div class="action-buttons">
								<a href={ templ.URL(fmt.Sprintf("/web/hosts/%s", host.ID)) } class="btn-icon" title="View Details">üëÅÔ∏è</a>
								<a href={ templ.URL(fmt.Sprintf("/web/containers?host=%s", host.ID)) } class="btn-icon" title="View Containers">üì¶</a>
							</div>
						</td>
					</tr>
				}
			</tbody>
		</table>
		@Pagination(pagination, "/web/hosts", queryParams)
	</div>
}

// Topology view template (with user)
templ TopologyViewWithUser(topology *storage.DatacenterTopology, topologies map[string]*storage.DatacenterTopology, datacenters map[string]bool, datacenter string, user *models.User) {
	@LayoutWithUser("Topology", user) {
		<div class="page-header">
			<h2>Infrastructure Topology</h2>
			<div class="filters">
				<select name="datacenter" hx-get="/web/topology" hx-target="main .container" hx-include="[name='datacenter']">
					<option value="all" selected?={ datacenter == "all" }>All Datacenters</option>
					for dc := range datacenters {
						<option value={ dc } selected?={ datacenter == dc }>{ dc }</option>
					}
				</select>
			</div>
		</div>

		if topology != nil {
			<!-- Single Datacenter View -->
			<div class="topology-view">
				<div class="datacenter-section">
					<h3 class="datacenter-title">üìç { topology.Datacenter }</h3>
					<div class="topology-grid">
						for hostID, hostTopo := range topology.Hosts {
							<div class="host-card">
								<div class="host-header">
									<h4>
										<a href={ templ.URL(fmt.Sprintf("/web/hosts/%s", hostID)) }>üñ•Ô∏è { hostTopo.Host.Name }</a>
									</h4>
									<span class={ fmt.Sprintf("badge badge-%s", hostTopo.Host.Status) }>
										{ hostTopo.Host.Status }
									</span>
								</div>
								<div class="host-details">
									<p><strong>IP:</strong> { hostTopo.Host.IPAddress }</p>
									<p><strong>CPU:</strong> { fmt.Sprintf("%d cores", hostTopo.Host.CPU) }</p>
									<p><strong>Memory:</strong> { fmt.Sprintf("%.1f GB", float64(hostTopo.Host.Memory) / 1024 / 1024 / 1024) }</p>
								</div>
								<div class="containers-section">
									<h5>
										Containers:
										if hostTopo.ContainerCount > 0 {
											<a href={ templ.URL(fmt.Sprintf("/web/containers?host=%s", hostID)) }>
												{ fmt.Sprintf("%d", hostTopo.ContainerCount) }
											</a>
										} else {
											<span>0</span>
										}
									</h5>
								</div>
							</div>
						}
					</div>
				</div>
			</div>
		} else if topologies != nil && len(topologies) > 0 {
			<!-- All Datacenters View -->
			<div class="topology-view">
				for dcName, dcTopo := range topologies {
					<div class="datacenter-section">
						<h3 class="datacenter-title">üìç { dcName }</h3>
						<div class="topology-grid">
							for hostID, hostTopo := range dcTopo.Hosts {
								<div class="host-card">
									<div class="host-header">
										<h4>
											<a href={ templ.URL(fmt.Sprintf("/web/hosts/%s", hostID)) }>üñ•Ô∏è { hostTopo.Host.Name }</a>
										</h4>
										<span class={ fmt.Sprintf("badge badge-%s", hostTopo.Host.Status) }>
											{ hostTopo.Host.Status }
										</span>
									</div>
									<div class="host-details">
										<p><strong>IP:</strong> { hostTopo.Host.IPAddress }</p>
										<p><strong>CPU:</strong> { fmt.Sprintf("%d cores", hostTopo.Host.CPU) }</p>
										<p><strong>Memory:</strong> { fmt.Sprintf("%.1f GB", float64(hostTopo.Host.Memory) / 1024 / 1024 / 1024) }</p>
									</div>
									<div class="containers-section">
										<h5>
											Containers:
											if hostTopo.ContainerCount > 0 {
												<a href={ templ.URL(fmt.Sprintf("/web/containers?host=%s", hostID)) }>
													{ fmt.Sprintf("%d", hostTopo.ContainerCount) }
												</a>
											} else {
												<span>0</span>
											}
										</h5>
									</div>
								</div>
							}
						</div>
					</div>
				}
			</div>
		} else {
			<div class="empty-state">
				<div class="empty-icon">üìä</div>
				<h3>No Infrastructure Data</h3>
				<p>No hosts or containers found. Start the agent to begin monitoring your infrastructure.</p>
			</div>
		}
	}
}


// Container detail view template (with user)
templ ContainerDetailWithUser(container *models.Container, host *models.Host, stack *models.Stack, belongsToStack bool, user *models.User) {
	@LayoutWithUser("Container Details", user) {
		<div class="page-header">
			<div>
				<h2>Container Details</h2>
			</div>
			<div class="action-buttons">
				<a href="/web/containers" class="btn btn-secondary">‚Üê Back to Containers</a>
				if belongsToStack && stack != nil {
					<div class="alert alert-info" style="margin: 0; padding: 8px 12px; display: inline-block;">
						üì¶ Part of stack: <a href={ templ.URL(fmt.Sprintf("/web/stacks/%s", stack.ID)) } style="color: inherit; font-weight: bold;">{ stack.Name }</a>
					</div>
				} else {
					<form method="POST" action={ templ.URL(fmt.Sprintf("/web/containers/%s/delete", container.ID)) } id="delete-container-form" style="display: inline;">
						<button type="button" class="btn btn-danger" data-container-name={ container.Name } onclick="showConfirmModal('Delete Container', 'Are you sure you want to delete container &quot;' + this.dataset.containerName + '&quot;? This action cannot be undone.', 'Delete', function() { document.getElementById('delete-container-form').submit(); })">üóëÔ∏è Delete Container</button>
					</form>
				}
			</div>
		</div>

		<div class="detail-container">
			<div class="detail-section">
				<h3>Basic Information</h3>
				<div class="detail-grid">
					<div class="detail-item">
						<span class="detail-label">Name:</span>
						<span class="detail-value"><strong>{ container.Name }</strong></span>
					</div>
					<div class="detail-item">
						<span class="detail-label">ID:</span>
						<span class="detail-value">{ container.ID }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Status:</span>
						<span class={ fmt.Sprintf("badge badge-%s", container.Status) }>
							{ container.Status }
						</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Image:</span>
						<span class="detail-value">{ container.Image }</span>
					</div>
				</div>
			</div>

			if host != nil {
				<div class="detail-section">
					<h3>Host Information</h3>
					<div class="detail-grid">
						<div class="detail-item">
							<span class="detail-label">Host Name:</span>
							<span class="detail-value">
								<a href={ templ.URL(fmt.Sprintf("/web/hosts/%s", host.ID)) }>{ host.Name }</a>
							</span>
						</div>
						<div class="detail-item">
							<span class="detail-label">Host IP:</span>
							<span class="detail-value">{ host.IPAddress }</span>
						</div>
						<div class="detail-item">
							<span class="detail-label">Datacenter:</span>
							<span class="detail-value">{ host.Datacenter }</span>
						</div>
					</div>
				</div>
			}

			if len(container.Ports) > 0 {
				<div class="detail-section">
					<h3>Network Ports</h3>
					<div class="table-container">
						<table class="data-table">
							<thead>
								<tr>
									<th>Host Port</th>
									<th>Container Port</th>
									<th>Protocol</th>
								</tr>
							</thead>
							<tbody>
								for _, port := range container.Ports {
									<tr>
										<td>{ fmt.Sprintf("%d", port.HostPort) }</td>
										<td>{ fmt.Sprintf("%d", port.ContainerPort) }</td>
										<td>{ port.Protocol }</td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				</div>
			}

			if len(container.Env) > 0 {
				<div class="detail-section">
					<h3>Environment Variables</h3>
					<div class="table-container">
						<table class="data-table">
							<thead>
								<tr>
									<th>Variable</th>
									<th>Value</th>
								</tr>
							</thead>
							<tbody>
								for key, value := range container.Env {
									<tr>
										<td><code>{ key }</code></td>
										<td><code>{ value }</code></td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				</div>
			}

			if container.Created != "" {
				<div class="detail-section">
					<h3>Timestamps</h3>
					<div class="detail-grid">
						<div class="detail-item">
							<span class="detail-label">Created:</span>
							<span class="detail-value">{ container.Created }</span>
						</div>
					</div>
				</div>
			}

			<div class="detail-section">
				<h3>JSON-LD Metadata</h3>
				<div class="detail-grid">
					<div class="detail-item">
						<span class="detail-label">Context:</span>
						<span class="detail-value">{ container.Context }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Type:</span>
						<span class="detail-value">{ container.Type }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">ID:</span>
						<span class="detail-value"><small>{ container.ID }</small></span>
					</div>
				</div>
			</div>
		</div>
	}
}

// Host detail view template (with user)
templ HostDetailWithUser(host *models.Host, containers []*models.Container, user *models.User) {
	@LayoutWithUser("Host Details", user) {
		<div class="page-header">
			<div>
				<h2>Host Details</h2>
			</div>
			<div class="action-buttons">
				<a href="/web/hosts" class="btn btn-secondary">‚Üê Back to Hosts</a>
				<a href={ templ.URL(fmt.Sprintf("/web/hosts/%s/edit", host.ID)) } class="btn btn-primary">‚úèÔ∏è Edit Host</a>
				<form method="POST" action={ templ.URL(fmt.Sprintf("/web/hosts/%s/delete", host.ID)) } id="delete-host-form" style="display: inline;">
					<button type="button" class="btn btn-danger" data-host-name={ host.Name } onclick="showConfirmModal('Delete Host', 'Are you sure you want to delete host &quot;' + this.dataset.hostName + '&quot;? This action cannot be undone.', 'Delete', function() { document.getElementById('delete-host-form').submit(); })">üóëÔ∏è Delete Host</button>
				</form>
			</div>
		</div>

		<div class="detail-container">
			<div class="detail-section">
				<h3>Basic Information</h3>
				<div class="detail-grid">
					<div class="detail-item">
						<span class="detail-label">Name:</span>
						<span class="detail-value"><strong>{ host.Name }</strong></span>
					</div>
					<div class="detail-item">
						<span class="detail-label">ID:</span>
						<span class="detail-value">{ host.ID }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Status:</span>
						<span class={ fmt.Sprintf("badge badge-%s", host.Status) }>
							{ host.Status }
						</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">IP Address:</span>
						<span class="detail-value">{ host.IPAddress }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Datacenter:</span>
						<span class="detail-value">{ host.Datacenter }</span>
					</div>
				</div>
			</div>

			<div class="detail-section">
				<h3>Hardware Resources</h3>
				<div class="detail-grid">
					<div class="detail-item">
						<span class="detail-label">CPU Cores:</span>
						<span class="detail-value">{ fmt.Sprintf("%d cores", host.CPU) }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Memory:</span>
						<span class="detail-value">{ fmt.Sprintf("%.2f GB", float64(host.Memory) / 1024 / 1024 / 1024) }</span>
					</div>
				</div>
			</div>

			<div class="detail-section">
				<h3>Containers ({ fmt.Sprintf("%d", len(containers)) })</h3>
				if len(containers) > 0 {
					<div class="table-container">
						<table class="data-table">
							<thead>
								<tr>
									<th>Name</th>
									<th>Image</th>
									<th>Status</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody>
								for _, container := range containers {
									<tr>
										<td>
											<strong>{ container.Name }</strong>
											<br/>
											<small class="text-muted">{ container.ID }</small>
										</td>
										<td>{ container.Image }</td>
										<td>
											<span class={ fmt.Sprintf("badge badge-%s", container.Status) }>
												{ container.Status }
											</span>
										</td>
										<td>
											<a href={ templ.URL(fmt.Sprintf("/web/containers/%s", container.ID)) } class="btn-icon" title="View Details">üëÅÔ∏è</a>
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				} else {
					<p class="no-data">No containers running on this host</p>
				}
			</div>

			<div class="detail-section">
				<h3>JSON-LD Metadata</h3>
				<div class="detail-grid">
					<div class="detail-item">
						<span class="detail-label">Context:</span>
						<span class="detail-value">{ host.Context }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Type:</span>
						<span class="detail-value">{ host.Type }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">ID:</span>
						<span class="detail-value"><small>{ host.ID }</small></span>
					</div>
				</div>
			</div>
		</div>
	}
}

// Login page template
templ LoginPage(errorMsg string) {
	<!DOCTYPE html>
	<html lang="en">
	<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<title>Login - Graphium</title>
		<link rel="stylesheet" href="/static/css/styles.css"/>
	</head>
	<body>
		<div class="login-container">
			<div class="login-box">
				<div class="login-header">
					<h1>üß¨ Graphium</h1>
					<p>Container Intelligence Platform</p>
				</div>

				if errorMsg != "" {
					<div class="alert alert-error">
						{ errorMsg }
					</div>
				}

				<form method="POST" action="/web/auth/login" class="login-form">
					<div class="form-group">
						<label for="username">Username</label>
						<input type="text" id="username" name="username" required autocomplete="username"/>
					</div>

					<div class="form-group">
						<label for="password">Password</label>
						<input type="password" id="password" name="password" required autocomplete="current-password"/>
					</div>

					<button type="submit" class="btn btn-primary btn-block">Login</button>
				</form>
			</div>
		</div>
	</body>
	</html>
}

// User list page template for admin
templ UsersList(users []*models.User, currentUser *models.User) {
	@LayoutWithUser("User Management", currentUser) {
		<div class="page-header">
			<h2>User Management</h2>
			<div class="header-actions">
				<a href="/web/users/new" class="btn btn-primary">‚ûï Add User</a>
			</div>
		</div>

		<div class="table-container">
			<table class="data-table">
				<thead>
					<tr>
						<th>Username</th>
						<th>Email</th>
						<th>Name</th>
						<th>Roles</th>
						<th>Status</th>
						<th>Last Login</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					if len(users) == 0 {
						<tr>
							<td colspan="7" class="text-center text-muted">No users found</td>
						</tr>
					}
					for _, user := range users {
						<tr>
							<td><strong>{ user.Username }</strong></td>
							<td>{ user.Email }</td>
							<td>{ user.Name }</td>
							<td>
								<div class="roles-list">
									for _, role := range user.Roles {
										if role == models.RoleAdmin {
											<span class="badge badge-danger">{ string(role) }</span>
										} else if role == models.RoleUser {
											<span class="badge badge-success">{ string(role) }</span>
										} else if role == models.RoleViewer {
											<span class="badge badge-info">{ string(role) }</span>
										} else {
											<span class="badge badge-secondary">{ string(role) }</span>
										}
									}
								</div>
							</td>
							<td>
								if user.Enabled {
									<span class="status-badge status-running">Active</span>
								} else {
									<span class="status-badge status-stopped">Disabled</span>
								}
							</td>
							<td>
								if user.LastLoginAt != nil {
									<small>{ user.LastLoginAt.Format("2006-01-02 15:04") }</small>
								} else {
									<span class="text-muted">Never</span>
								}
							</td>
							<td class="actions">
								<a href={ templ.URL(fmt.Sprintf("/web/users/%s", user.ID)) } class="btn-icon" title="View Details">üëÅÔ∏è</a>
								if user.ID != currentUser.ID {
									<a href={ templ.URL(fmt.Sprintf("/web/users/%s/edit", user.ID)) } class="btn-icon" title="Edit User">‚úèÔ∏è</a>
									<button
										type="button"
										class="btn-icon"
										title="Delete User"
										onclick={ templ.ComponentScript{Call: fmt.Sprintf("showDeleteModal('%s', '%s')", user.ID, user.Username)} }
									>
										üóëÔ∏è
									</button>
								}
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>

		<!-- Delete User Confirmation Modal -->
		<div id="deleteModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>‚ö†Ô∏è Confirm Deletion</h3>
				</div>
				<div class="modal-body">
					<p>Are you sure you want to delete user <strong id="deleteUsername"></strong>?</p>
					<p class="text-muted">This action cannot be undone.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
					<form id="deleteForm" method="POST" style="display: inline;">
						<button type="submit" class="btn btn-danger">Delete User</button>
					</form>
				</div>
			</div>
		</div>

		<script>
			function showDeleteModal(userId, username) {
				const modal = document.getElementById('deleteModal');
				const usernameEl = document.getElementById('deleteUsername');
				const form = document.getElementById('deleteForm');

				usernameEl.textContent = username;
				form.action = '/web/users/' + userId + '/delete';
				modal.style.display = 'flex';
			}

			function closeDeleteModal() {
				const modal = document.getElementById('deleteModal');
				modal.style.display = 'none';
			}

			function showRevokeApiKeyModal(userId, username, apiKey) {
				const modal = document.getElementById('revokeApiKeyModal');
				const apiKeyEl = document.getElementById('revokeApiKey');
				const usernameEl = document.getElementById('revokeUsername');
				const form = document.getElementById('revokeApiKeyForm');

				// Truncate API key for display (show first 8 and last 4 chars)
				const displayKey = apiKey.length > 12 ?
					apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4) :
					apiKey;
				apiKeyEl.textContent = displayKey;
				usernameEl.textContent = username;
				form.action = '/web/users/' + userId + '/apikeys/' + encodeURIComponent(apiKey) + '/revoke';
				modal.style.display = 'flex';
			}

			function closeRevokeApiKeyModal() {
				const modal = document.getElementById('revokeApiKeyModal');
				modal.style.display = 'none';
			}

			// Close modal when clicking outside of it
			window.onclick = function(event) {
				const deleteModal = document.getElementById('deleteModal');
				const revokeModal = document.getElementById('revokeApiKeyModal');

				if (event.target == deleteModal) {
					closeDeleteModal();
				}
				if (event.target == revokeModal) {
					closeRevokeApiKeyModal();
				}
			}

			// Close modal on Escape key
			document.addEventListener('keydown', function(event) {
				if (event.key === 'Escape') {
					closeDeleteModal();
					closeRevokeApiKeyModal();
				}
			});
		</script>
	}
}

// User detail page template
templ UserDetail(user *models.User, currentUser *models.User, isAdmin bool) {
	@LayoutWithUser("User Details", currentUser) {
		<div class="page-header">
			<div>
				<a href="/web/users" class="btn btn-secondary">‚Üê Back to Users</a>
				<h2>User Details</h2>
			</div>
			<div class="header-actions">
				if user.ID == currentUser.ID || isAdmin {
					<a href={ templ.URL(fmt.Sprintf("/web/users/%s/edit", user.ID)) } class="btn btn-primary">‚úèÔ∏è Edit</a>
				}
			</div>
		</div>

		<div class="detail-container">
			<div class="detail-section">
				<h3>Account Information</h3>
				<div class="detail-grid">
					<div class="detail-item">
						<span class="detail-label">Username:</span>
						<span class="detail-value"><strong>{ user.Username }</strong></span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Email:</span>
						<span class="detail-value">{ user.Email }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Name:</span>
						<span class="detail-value">{ user.Name }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Status:</span>
						if user.Enabled {
							<span class="status-badge status-running">Active</span>
						} else {
							<span class="status-badge status-stopped">Disabled</span>
						}
					</div>
				</div>
			</div>

			<div class="detail-section">
				<h3>Roles & Permissions</h3>
				<div class="roles-list">
					for _, role := range user.Roles {
						if role == models.RoleAdmin {
							<span class="badge badge-danger">{ string(role) }</span>
						} else if role == models.RoleUser {
							<span class="badge badge-success">{ string(role) }</span>
						} else if role == models.RoleViewer {
							<span class="badge badge-info">{ string(role) }</span>
						} else {
							<span class="badge badge-secondary">{ string(role) }</span>
						}
					}
				</div>
			</div>

			<div class="detail-section">
				<h3>Activity</h3>
				<div class="detail-grid">
					<div class="detail-item">
						<span class="detail-label">Created:</span>
						<span class="detail-value">{ user.CreatedAt.Format("2006-01-02 15:04:05") }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Last Updated:</span>
						<span class="detail-value">{ user.UpdatedAt.Format("2006-01-02 15:04:05") }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Last Login:</span>
						if user.LastLoginAt != nil {
							<span class="detail-value">{ user.LastLoginAt.Format("2006-01-02 15:04:05") }</span>
						} else {
							<span class="detail-value text-muted">Never</span>
						}
					</div>
				</div>
			</div>

			if user.ID == currentUser.ID {
				<div class="detail-section">
					<h3>API Keys</h3>
					if len(user.APIKeys) > 0 {
						<div class="api-keys-list">
							for i, key := range user.APIKeys {
								<div class="api-key-item">
									<code>{ key[:8] }...{ key[len(key)-8:] }</code>
									<form method="POST" action={ templ.URL(fmt.Sprintf("/web/users/%s/api-keys/%d/revoke", user.ID, i)) } style="display: inline;" onsubmit="return confirm('Are you sure you want to revoke this API key?');">
										<button type="submit" class="btn btn-sm btn-danger">Revoke</button>
									</form>
								</div>
							}
						</div>
					} else {
						<p class="text-muted">No API keys generated</p>
					}
					<form method="POST" action={ templ.URL(fmt.Sprintf("/web/users/%s/api-keys/generate", user.ID)) }>
						<button type="submit" class="btn btn-primary">üîë Generate New API Key</button>
					</form>
				</div>
			}

			<div class="detail-section">
				<h3>JSON-LD Metadata</h3>
				<div class="detail-grid">
					<div class="detail-item">
						<span class="detail-label">Context:</span>
						<span class="detail-value"><small>{ user.Context }</small></span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Type:</span>
						<span class="detail-value">{ user.Type }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">ID:</span>
						<span class="detail-value"><small>{ user.ID }</small></span>
					</div>
				</div>
			</div>
		</div>
	}
}

// User create form template
templ UserFormCreate(user *models.User, currentUser *models.User, errorMsg string) {
	@LayoutWithUser("Create User", currentUser) {
		@userFormContent(user, true, errorMsg)
	}
}

// User edit form template
templ UserFormEdit(user *models.User, currentUser *models.User, errorMsg string) {
	@LayoutWithUser("Edit User", currentUser) {
		@userFormContent(user, false, errorMsg)
	}
}

// User form content (shared between create and edit)
templ userFormContent(user *models.User, isNew bool, errorMsg string) {
		<div class="page-header">
			<div>
				<a href="/web/users" class="btn btn-secondary">‚Üê Back to Users</a>
				<h2>
					if isNew {
						Create New User
					} else {
						Edit User
					}
				</h2>
			</div>
		</div>

		if errorMsg != "" {
			<div class="alert alert-error">
				{ errorMsg }
			</div>
		}

		<div class="form-container">
			if isNew {
				<form method="POST" action="/web/users/create" class="user-form">
					@userFormFields(user, isNew)
				</form>
			} else {
				<form method="POST" action={ templ.URL(fmt.Sprintf("/web/users/%s/update", user.ID)) } class="user-form">
					@userFormFields(user, isNew)
				</form>
			}
		</div>
}

// User form fields (shared between create and edit forms)
templ userFormFields(user *models.User, isNew bool) {
				<div class="form-section">
					<h3>Account Information</h3>

					<div class="form-group">
						<label for="username">Username *</label>
						<input type="text" id="username" name="username" value={ user.Username } required disabled?={ !isNew }/>
						if !isNew {
							<small class="form-text">Username cannot be changed</small>
						}
					</div>

					<div class="form-group">
						<label for="email">Email</label>
						<input type="email" id="email" name="email" value={ user.Email }/>
					</div>

					<div class="form-group">
						<label for="name">Full Name</label>
						<input type="text" id="name" name="name" value={ user.Name }/>
					</div>

					if isNew {
						<div class="form-group">
							<label for="password">Password *</label>
							<input type="password" id="password" name="password" required minlength="8"/>
							<small class="form-text">Minimum 8 characters</small>
						</div>
					}
				</div>

				<div class="form-section">
					<h3>Roles & Permissions</h3>

					<div class="form-group">
						<label class="checkbox-label">
							<input type="checkbox" name="roles" value="admin" checked?={ user.HasRole(models.RoleAdmin) }/>
							<span>Administrator - Full system access</span>
						</label>
					</div>

					<div class="form-group">
						<label class="checkbox-label">
							<input type="checkbox" name="roles" value="user" checked?={ user.HasRole(models.RoleUser) }/>
							<span>User - Read/write access to containers and hosts</span>
						</label>
					</div>

					<div class="form-group">
						<label class="checkbox-label">
							<input type="checkbox" name="roles" value="viewer" checked?={ user.HasRole(models.RoleViewer) }/>
							<span>Viewer - Read-only access</span>
						</label>
					</div>
				</div>

				<div class="form-section">
					<h3>Status</h3>

					<div class="form-group">
						<label class="checkbox-label">
							<input type="checkbox" name="enabled" checked?={ user.Enabled }/>
							<span>Account Enabled</span>
						</label>
					</div>
				</div>

				<div class="form-actions">
					<button type="submit" class="btn btn-primary">
						if isNew {
							Create User
						} else {
							Update User
						}
					</button>
					<a href="/web/users" class="btn btn-secondary">Cancel</a>
				</div>
}

// Profile/Settings page for current user
templ ProfilePage(user *models.User, errorMsg string, success string) {
	@LayoutWithUser("My Profile", user) {
		<div class="page-header">
			<h2>My Profile</h2>
		</div>

		if errorMsg != "" {
			<div class="alert alert-error">
				{ errorMsg }
			</div>
		}

		if success != "" {
			<div class="alert alert-success">
				{ success }
			</div>
		}

		<div class="detail-container">
			<div class="detail-section">
				<h3>Account Information</h3>
				<div class="detail-grid">
					<div class="detail-item">
						<span class="detail-label">Username:</span>
						<span class="detail-value"><strong>{ user.Username }</strong></span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Email:</span>
						<span class="detail-value">{ user.Email }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Name:</span>
						<span class="detail-value">{ user.Name }</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Roles:</span>
						<span class="detail-value">
							<div class="roles-list">
								for _, role := range user.Roles {
									if role == models.RoleAdmin {
										<span class="badge badge-danger">{ string(role) }</span>
									} else if role == models.RoleUser {
										<span class="badge badge-success">{ string(role) }</span>
									} else if role == models.RoleViewer {
										<span class="badge badge-info">{ string(role) }</span>
									} else {
										<span class="badge badge-secondary">{ string(role) }</span>
									}
								}
							</div>
						</span>
					</div>
				</div>
			</div>

			<div class="detail-section">
				<h3>Change Password</h3>
				<form method="POST" action="/web/profile/password" class="password-form">
					<div class="form-group">
						<label for="current_password">Current Password</label>
						<input type="password" id="current_password" name="current_password" required/>
					</div>

					<div class="form-group">
						<label for="new_password">New Password</label>
						<input type="password" id="new_password" name="new_password" required minlength="8"/>
						<small class="form-text">Minimum 8 characters</small>
					</div>

					<div class="form-group">
						<label for="confirm_password">Confirm New Password</label>
						<input type="password" id="confirm_password" name="confirm_password" required minlength="8"/>
					</div>

					<button type="submit" class="btn btn-primary">Change Password</button>
				</form>
			</div>
		</div>
	}
}

// Container Logs view template
templ ContainerLogsView(container *models.Container, host *models.Host, user *models.User) {
	@LayoutWithUser("Container Logs", user) {
		<div class="page-header">
			<div>
				<a href={ templ.URL(fmt.Sprintf("/web/containers/%s", container.ID)) } class="btn btn-secondary">‚Üê Back to Container</a>
				<h2>Container Logs: { container.Name }</h2>
			</div>
		</div>

		<div class="detail-container">
			<div class="detail-section">
				<div class="detail-grid" style="margin-bottom: 1rem;">
					<div class="detail-item">
						<span class="detail-label">Container:</span>
						<span class="detail-value"><strong>{ container.Name }</strong></span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Status:</span>
						<span class={ fmt.Sprintf("badge badge-%s", container.Status) }>
							{ container.Status }
						</span>
					</div>
					if host != nil {
						<div class="detail-item">
							<span class="detail-label">Host:</span>
							<span class="detail-value">
								<a href={ templ.URL(fmt.Sprintf("/web/hosts/%s", host.ID)) }>{ host.Name }</a>
							</span>
						</div>
					}
				</div>

				<div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
					<label style="display: flex; align-items: center; gap: 0.5rem;">
						<input type="checkbox" id="auto-refresh" checked/>
						<span>Auto-refresh (5s)</span>
					</label>
					<label style="display: flex; align-items: center; gap: 0.5rem;">
						<span>Lines:</span>
						<select id="lines-select" style="padding: 0.25rem;">
							<option value="100">100</option>
							<option value="500">500</option>
							<option value="1000" selected>1000</option>
							<option value="5000">5000</option>
						</select>
					</label>
					<a href={ templ.URL(fmt.Sprintf("/api/v1/containers/%s/logs/download?lines=1000", container.ID)) } class="btn btn-secondary" download>
						üì• Download Logs
					</a>
				</div>

				<div id="logs-container" style="background: #1a1a1a; color: #00ff00; padding: 1rem; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.85rem; max-height: 600px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">
					<div hx-get={ fmt.Sprintf("/api/v1/containers/%s/logs?tail=1000", container.ID) } hx-trigger="load, every 5s" hx-swap="innerHTML">
						Loading logs...
					</div>
				</div>
			</div>
		</div>

		<script>
			// Auto-refresh toggle
			document.getElementById('auto-refresh').addEventListener('change', function(e) {
				const logsDiv = document.querySelector('#logs-container > div');
				if (e.target.checked) {
					logsDiv.setAttribute('hx-trigger', 'load, every 5s');
				} else {
					logsDiv.setAttribute('hx-trigger', 'load');
				}
				htmx.process(logsDiv);
			});

			// Lines selector
			document.getElementById('lines-select').addEventListener('change', function(e) {
				const lines = e.target.value;
				const logsDiv = document.querySelector('#logs-container > div');
				const containerID = '{ container.ID }';
				logsDiv.setAttribute('hx-get', `/api/v1/containers/${containerID}/logs?tail=${lines}`);
				htmx.trigger(logsDiv, 'load');

				// Update download link
				const downloadLink = document.querySelector('a[download]');
				downloadLink.href = `/api/v1/containers/${containerID}/logs/download?lines=${lines}`;
			});

			// Auto-scroll to bottom on new content
			const logsContainer = document.getElementById('logs-container');
			const observer = new MutationObserver(() => {
				logsContainer.scrollTop = logsContainer.scrollHeight;
			});
			observer.observe(logsContainer, { childList: true, subtree: true });
		</script>
	}
}

templ StacksListWithUser(stacks []*models.Stack, pagination PaginationInfo, user *models.User) {
	@LayoutWithUser("Stacks", user) {
		<div class="page-header">
			<h2>Stacks</h2>
			<div class="filters">
				<a href="/web/stacks/jsonld/deploy" class="btn btn-primary">+ Deploy New Stack</a>
			</div>
		</div>
		<div class="table-container" id="stacks-table" hx-get="/web/stacks/table" hx-trigger="load" hx-swap="innerHTML">
			<div class="loading">Loading stacks...</div>
		</div>
	}
}

templ StacksTableWithPagination(stacks []*models.Stack, pagination PaginationInfo, queryParams string) {
	if len(stacks) == 0 {
		<div class="empty-state">
			<p>No stacks deployed yet</p>
			<p><a href="/web/stacks/jsonld/deploy" class="btn btn-primary">Deploy Your First Stack</a></p>
		</div>
	} else {
		<table class="data-table">
			<thead>
				<tr>
					<th>Name</th>
					<th>Status</th>
					<th>Datacenter</th>
					<th>Mode</th>
					<th>Strategy</th>
					<th>Deployed</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				for _, stack := range stacks {
					<tr>
						<td>
							<a href={ templ.URL("/web/stacks/" + stack.ID) } style="text-decoration: none; color: inherit;">{ stack.Name }</a>
							if stack.Description != "" {
								<br/><small class="text-muted">{ stack.Description }</small>
							}
						</td>
						<td>
							<span class={ "badge badge-" + stack.Status }>{ stack.Status }</span>
						</td>
						<td>{ stack.Datacenter }</td>
						<td>{ stack.Deployment.Mode }</td>
						<td>{ stack.Deployment.PlacementStrategy }</td>
						<td>
							if stack.DeployedAt != nil {
								{ stack.DeployedAt.Format("2006-01-02 15:04") }
							} else {
								<span class="text-muted">Not deployed</span>
							}
						</td>
						<td>
							<a href={ templ.URL("/web/stacks/" + stack.ID) } class="btn btn-sm btn-secondary">View</a>
						</td>
					</tr>
				}
			</tbody>
		</table>
	}
}

templ StackDetailWithUser(stack *models.Stack, deployment *models.StackDeployment, containers []*models.Container, user *models.User) {
	@LayoutWithUser("Stack Detail", user) {
		<div class="page-header">
			<div>
				<h2>{ stack.Name }</h2>
				if stack.Description != "" {
					<p>{ stack.Description }</p>
				}
			</div>
			<div class="page-actions">
				<a href="/web/stacks" class="btn btn-secondary">Back to Stacks</a>
				<span class={ "badge badge-" + stack.Status }>{ stack.Status }</span>
				<a href={ templ.URL(fmt.Sprintf("/web/stacks/%s/edit", stack.ID)) } class="btn btn-secondary">Edit</a>
				if stack.Status == "running" {
					<form method="POST" action={ templ.URL(fmt.Sprintf("/web/stacks/%s/stop", stack.ID)) } id="stop-stack-form" style="display: inline;">
						<button type="button" class="btn btn-warning" data-stack-name={ stack.Name } onclick="showConfirmModal('Stop Stack', 'Are you sure you want to stop stack &quot;' + this.dataset.stackName + '&quot;?', 'Stop', function() { document.getElementById('stop-stack-form').submit(); })">Stop</button>
					</form>
					<form method="POST" action={ templ.URL(fmt.Sprintf("/web/stacks/%s/restart", stack.ID)) } id="restart-stack-form" style="display: inline;">
						<button type="button" class="btn btn-warning" data-stack-name={ stack.Name } onclick="showConfirmModal('Restart Stack', 'Are you sure you want to restart stack &quot;' + this.dataset.stackName + '&quot;?', 'Restart', function() { document.getElementById('restart-stack-form').submit(); })">Restart</button>
					</form>
				} else if stack.Status == "stopped" {
					<form method="POST" action={ templ.URL(fmt.Sprintf("/web/stacks/%s/start", stack.ID)) } style="display: inline;">
						<button type="submit" class="btn btn-success">Start</button>
					</form>
				}
				<form method="POST" action={ templ.URL(fmt.Sprintf("/web/stacks/%s/delete", stack.ID)) } id="delete-stack-form" style="display: inline;">
					<button type="button" class="btn btn-danger" data-stack-name={ stack.Name } onclick="showConfirmModal('Delete Stack', 'Are you sure you want to delete stack &quot;' + this.dataset.stackName + '&quot;? This will delete all containers in the stack. This action cannot be undone.', 'Delete', function() { document.getElementById('delete-stack-form').submit(); })">Delete</button>
				</form>
			</div>
		</div>
		<div class="detail-container">
			<div class="detail-section">
				<h3>Stack Information</h3>
				<dl class="detail-list">
					<dt>Stack ID</dt>
					<dd>{ stack.ID }</dd>
					<dt>Datacenter</dt>
					<dd>{ stack.Datacenter }</dd>
					<dt>Deployment Mode</dt>
					<dd>{ stack.Deployment.Mode }</dd>
					<dt>Placement Strategy</dt>
					<dd>{ stack.Deployment.PlacementStrategy }</dd>
					<dt>Network Mode</dt>
					<dd>{ stack.Deployment.NetworkMode }</dd>
					<dt>Owner</dt>
					<dd>{ stack.Owner }</dd>
					<dt>Created</dt>
					<dd>{ stack.CreatedAt.Format("2006-01-02 15:04:05") }</dd>
					if stack.DeployedAt != nil {
						<dt>Deployed</dt>
						<dd>{ stack.DeployedAt.Format("2006-01-02 15:04:05") }</dd>
					}
				</dl>
			</div>
			if len(containers) > 0 {
				<div class="detail-section">
					<h3>Assigned Containers ({ fmt.Sprintf("%d", len(containers)) })</h3>
					<table class="data-table">
						<thead>
							<tr>
								<th>Name</th>
								<th>Image</th>
								<th>Status</th>
								<th>Host</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							for _, container := range containers {
								<tr>
									<td>
										<a href={ templ.URL(fmt.Sprintf("/web/containers/%s", container.ID)) } style="text-decoration: none; color: inherit;">{ container.Name }</a>
									</td>
									<td>{ container.Image }</td>
									<td>
										<span class={ "badge badge-" + container.Status }>{ container.Status }</span>
									</td>
									<td>{ container.HostedOn }</td>
									<td>
										<div class="action-buttons">
											<a href={ templ.URL(fmt.Sprintf("/web/containers/%s", container.ID)) } class="btn-icon" title="View Details">üëÅÔ∏è</a>
											<a href={ templ.URL(fmt.Sprintf("/web/containers/%s/logs", container.ID)) } class="btn-icon" title="View Logs">üìÑ</a>
										</div>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			}
			if deployment != nil && len(deployment.Placements) > 0 {
				<div class="detail-section">
					<h3>Container Placements</h3>
					<table class="data-table">
						<thead>
							<tr>
								<th>Container</th>
								<th>Host</th>
								<th>IP Address</th>
								<th>Ports</th>
								<th>Status</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							for _, placement := range deployment.Placements {
								<tr>
									<td>{ placement.ContainerName }</td>
									<td>{ placement.HostID }</td>
									<td>{ placement.IPAddress }</td>
									<td>
										for containerPort, hostPort := range placement.Ports {
											<span class="port-mapping">{ fmt.Sprintf("%d:%d", containerPort, hostPort) }</span>
										}
									</td>
									<td>
										<span class={ "badge badge-" + placement.Status }>{ placement.Status }</span>
									</td>
									<td>
										<div class="action-buttons">
											<a href={ templ.URL(fmt.Sprintf("/web/containers/%s", placement.ContainerID)) } class="btn-icon" title="View Details">üëÅÔ∏è</a>
											<a href={ templ.URL(fmt.Sprintf("/web/containers/%s/logs", placement.ContainerID)) } class="btn-icon" title="View Logs">üìÑ</a>
										</div>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			}
			if deployment != nil && len(deployment.NetworkConfig.ServiceEndpoints) > 0 {
				<div class="detail-section">
					<h3>Service Endpoints</h3>
					<dl class="detail-list">
						for serviceName, endpoint := range deployment.NetworkConfig.ServiceEndpoints {
							<dt>{ serviceName }</dt>
							<dd>{ endpoint }</dd>
						}
					</dl>
				</div>
			}
			if stack.ErrorMessage != "" {
				<div class="detail-section error">
					<h3>Error</h3>
					<p>{ stack.ErrorMessage }</p>
				</div>
			}
		</div>
	}
}

// Deploy stack form template
templ DeployStackFormWithUser(templates []StackTemplate, hosts []*models.Host, containers []*models.Container, datacenters map[string]bool, errorMsg string, user *models.User) {
	@LayoutWithUser("Deploy Stack", user) {
		<div class="page-header">
			<div>
				<h2>Deploy New Stack</h2>
				<p>Deploy a multi-container stack from a JSON-LD definition</p>
			</div>
			<div class="page-actions">
				<a href="/web/stacks" class="btn btn-secondary">‚Üê Back to Stacks</a>
			</div>
		</div>
		if errorMsg != "" {
			<div class="alert alert-error">
				{ errorMsg }
			</div>
		}
		<div class="form-container">
			<form method="POST" action="/web/stacks/deploy" class="stack-form">
				<div class="form-section">
					<h3>Stack Template</h3>
					<p class="form-help">Select a predefined template or write your own JSON-LD definition</p>
					if len(templates) > 0 {
						<div class="form-group">
							<label for="template-selector">Choose Template (Optional)</label>
							<select id="template-selector" class="form-select">
								<option value="">-- Custom Definition --</option>
								for _, tmpl := range templates {
									<option value={ tmpl.Content }>{ tmpl.Name } - { tmpl.Description }</option>
								}
							</select>
							<small class="form-text">Select a template to auto-fill the JSON editor below</small>
						</div>
					}
					<div class="form-group">
						<label for="stack_json">Stack Definition (JSON-LD) *</label>
						<textarea
							id="stack_json"
							name="stack_json"
							rows="20"
							class="form-textarea code-editor"
							required
							placeholder={`{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "my-stack",
  "description": "My application stack",
  "network": {
    "name": "my-network",
    "driver": "bridge"
  },
  "itemListElement": [
    {
      "@type": "SoftwareApplication",
      "position": 1,
      "name": "nginx",
      "image": "nginx:latest",
      "ports": [
        {"containerPort": 80, "hostPort": 8080}
      ]
    }
  ]
}`}></textarea>
						<small class="form-text">JSON-LD format using Schema.org vocabulary</small>
					</div>
				</div>
				<div class="form-section">
					<h3>Deployment Configuration</h3>
					<div class="form-group">
						<label for="deployment-mode">Deployment Mode</label>
						<select id="deployment-mode" name="deployment_mode" class="form-select">
							<option value="distributed" selected>Distributed - Deploy across multiple hosts</option>
							<option value="single-host">Single Host - Deploy on one host</option>
						</select>
					</div>
					<div class="form-group">
						<label for="placement-strategy">Placement Strategy</label>
						<select id="placement-strategy" name="placement_strategy" class="form-select">
							<option value="auto" selected>Auto - Graphium decides based on resources</option>
							<option value="spread">Spread - Distribute evenly across hosts</option>
							<option value="datacenter">Datacenter - Keep in same datacenter</option>
							<option value="manual">Manual - Specify host per container</option>
						</select>
					</div>
					if len(datacenters) > 0 {
						<div class="form-group">
							<label for="datacenter">Target Datacenter (Optional)</label>
							<select id="datacenter" name="datacenter" class="form-select">
								<option value="">-- Any Datacenter --</option>
								for dc := range datacenters {
									<option value={ dc }>{ dc }</option>
								}
							</select>
						</div>
					}
					if len(hosts) > 0 {
						<div class="form-group">
							<label>Target Hosts (Optional)</label>
							<small class="form-text">Select specific hosts for deployment. If none selected, will use all active hosts in selected datacenter (or all active hosts if no datacenter selected).</small>
							<div class="host-selection" style="margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
								for _, host := range hosts {
									<label class="checkbox-label" style="display: block; padding: 5px 0;">
										<input type="checkbox" name="target_hosts[]" value={ host.ID }/>
										<span>
											<strong>{ host.Name }</strong> ({ host.ID })
											if host.Datacenter != "" {
												<span class="text-muted"> - { host.Datacenter }</span>
											}
											<span class="text-muted"> - { host.IPAddress }</span>
											<span class={ "badge badge-" + host.Status } style="margin-left: 10px;">{ host.Status }</span>
										</span>
									</label>
								}
							</div>
						</div>
					} else {
						<div class="alert alert-warning">
							<strong>No Active Hosts Available!</strong> You need to register and activate at least one host before deploying stacks.
						</div>
					}
					if len(containers) > 0 {
						<div class="form-group">
							<label>Existing Containers (Optional)</label>
							<small class="form-text">Select existing containers to include in this stack. This allows you to group running containers into a logical stack without redeploying them.</small>
							<div class="container-selection" style="margin-top: 10px; max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
								for _, container := range containers {
									<label class="checkbox-label" style="display: block; padding: 5px 0;">
										<input type="checkbox" name="existing_containers[]" value={ container.ID }/>
										<span>
											<strong>{ container.Name }</strong>
											<span class="text-muted"> - { container.Image }</span>
											<span class={ "badge badge-" + container.Status } style="margin-left: 10px;">{ container.Status }</span>
											<br/>
											<small class="text-muted">{ container.ID[:12] } on { container.HostedOn }</small>
										</span>
									</label>
								}
							</div>
						</div>
					}
				</div>
				<div class="form-actions">
					<button type="submit" class="btn btn-primary">Deploy Stack</button>
					<a href="/web/stacks" class="btn btn-secondary">Cancel</a>
				</div>
			</form>
		</div>
		<script>
			// Template selector functionality
			const templateSelector = document.getElementById('template-selector');
			const jsonTextarea = document.getElementById('stack_json');
			let validationTimeout;

			if (templateSelector && jsonTextarea) {
				templateSelector.addEventListener('change', function() {
					if (this.value) {
						// Pretty print the JSON
						try {
							const formatted = JSON.stringify(JSON.parse(this.value), null, 2);
							jsonTextarea.value = formatted;
							validateJSON();
						} catch (e) {
							jsonTextarea.value = this.value;
						}
					}
				});

				// Real-time JSON validation
				jsonTextarea.addEventListener('input', function() {
					clearTimeout(validationTimeout);
					validationTimeout = setTimeout(validateJSON, 500);
				});

				// Initial validation
				if (jsonTextarea.value.trim()) {
					validateJSON();
				}
			}

			function validateJSON() {
				const jsonStr = jsonTextarea.value.trim();

				// Remove any existing validation messages
				const existingMsg = document.getElementById('json-validation');
				if (existingMsg) {
					existingMsg.remove();
				}

				if (!jsonStr) {
					return;
				}

				const validationDiv = document.createElement('div');
				validationDiv.id = 'json-validation';
				validationDiv.style.marginTop = '10px';
				validationDiv.style.padding = '10px';
				validationDiv.style.borderRadius = '4px';

				try {
					const parsed = JSON.parse(jsonStr);

					// Check required fields
					const errors = [];
					if (!parsed.name) {
						errors.push('Missing required field: "name"');
					}
					if (!parsed.itemListElement || !Array.isArray(parsed.itemListElement)) {
						errors.push('Missing or invalid "itemListElement" array');
					} else if (parsed.itemListElement.length === 0) {
						errors.push('Stack must contain at least one container');
					}

					if (errors.length > 0) {
						validationDiv.className = 'alert alert-warning';
						validationDiv.innerHTML = '<strong>Validation Warnings:</strong><ul style="margin: 5px 0 0 20px;">' +
							errors.map(e => '<li>' + e + '</li>').join('') + '</ul>';
					} else {
						validationDiv.className = 'alert alert-success';
						validationDiv.innerHTML = '‚úì Valid stack definition (' + parsed.itemListElement.length + ' container(s))';
					}
				} catch (e) {
					validationDiv.className = 'alert alert-error';
					validationDiv.innerHTML = '<strong>JSON Syntax Error:</strong> ' + e.message;
				}

				jsonTextarea.parentNode.appendChild(validationDiv);
			}
		</script>
	}
}

// Edit stack form template
templ EditStackFormWithUser(stack *models.Stack, containers []*models.Container, stackJSON string, errorMsg string, user *models.User) {
	@LayoutWithUser("Edit Stack", user) {
		<div class="page-header">
			<div>
				<a href={ templ.URL(fmt.Sprintf("/web/stacks/%s", stack.ID)) } class="btn btn-secondary">‚Üê Back to Stack</a>
				<h2>Edit Stack: { stack.Name }</h2>
				<p>Update stack metadata (name and description only)</p>
			</div>
		</div>
		if errorMsg != "" {
			<div class="alert alert-error">
				{ errorMsg }
			</div>
		}
		<div class="form-container">
			<form method="POST" action={ templ.URL(fmt.Sprintf("/web/stacks/%s/update", stack.ID)) } class="stack-form">
				<div class="form-section">
					<h3>Stack Information</h3>
					<div class="form-group">
						<label for="name">Stack Name *</label>
						<input type="text" id="name" name="name" value={ stack.Name } required/>
						<small class="form-text">Display name for this stack</small>
					</div>
					<div class="form-group">
						<label for="description">Description</label>
						<textarea id="description" name="description" rows="3" class="form-textarea">{ stack.Description }</textarea>
						<small class="form-text">Brief description of this stack's purpose</small>
					</div>
				</div>
				<div class="form-section">
					<h3>Current Configuration (Read-only)</h3>
					<div class="form-group">
						<label>Stack ID</label>
						<input type="text" value={ stack.ID } disabled/>
					</div>
					<div class="form-group">
						<label>Status</label>
						<input type="text" value={ stack.Status } disabled/>
					</div>
					<div class="form-group">
						<label>Placement Strategy</label>
						<input type="text" value={ stack.Deployment.PlacementStrategy } disabled/>
					</div>
					<div class="alert alert-info">
						<strong>Note:</strong> To change deployment configuration, you must redeploy the stack.
					</div>
				</div>
				if len(containers) > 0 {
					<div class="form-section">
						<h3>Manage Containers</h3>
						<p class="form-help">Select existing containers to assign to this stack</p>
						<div class="container-selection" style="margin-top: 10px; max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
							for _, container := range containers {
								<label class="checkbox-label" style="display: block; padding: 5px 0;">
									<input
										type="checkbox"
										name="stack_containers[]"
										value={ container.ID }
										if contains(stack.Containers, container.ID) {
											checked
										}
									/>
									<span>
										<strong>{ container.Name }</strong>
										<span class="text-muted"> - { container.Image }</span>
										<span class={ "badge badge-" + container.Status } style="margin-left: 10px;">{ container.Status }</span>
										<br/>
										<small class="text-muted">{ container.ID[:12] } on { container.HostedOn }</small>
									</span>
								</label>
							}
						</div>
						<small class="form-text">Check containers to add them to this stack, uncheck to remove them</small>
					</div>
				}
				<div class="form-actions">
					<button type="submit" class="btn btn-primary">Update Stack</button>
					<a href={ templ.URL(fmt.Sprintf("/web/stacks/%s", stack.ID)) } class="btn btn-secondary">Cancel</a>
				</div>
			</form>
		</div>
	}
}

// Stack logs aggregation view
templ StackLogsWithUser(stack *models.Stack, deployment *models.StackDeployment, containerIDs []string, user *models.User) {
	@LayoutWithUser("Stack Logs", user) {
		<div class="page-header">
			<div>
				<a href={ templ.URL(fmt.Sprintf("/web/stacks/%s", stack.ID)) } class="btn btn-secondary">‚Üê Back to Stack</a>
				<h2>Logs: { stack.Name }</h2>
				<p>Aggregated logs from all containers in this stack</p>
			</div>
			<div>
				<span class={ "badge badge-" + stack.Status }>{ stack.Status }</span>
			</div>
		</div>
		<div class="logs-container">
			if len(deployment.Placements) == 0 {
				<div class="empty-state">
					<p>No containers deployed in this stack</p>
				</div>
			} else {
				for _, placement := range deployment.Placements {
					<div class="log-section">
						<div class="log-header">
							<h3>{ placement.ContainerName }</h3>
							<div class="log-meta">
								<span class="log-host">Host: { placement.HostID }</span>
								<span class={ "badge badge-" + placement.Status }>{ placement.Status }</span>
							</div>
						</div>
						if placement.ContainerID != "" {
							<div class="log-content" id={ "logs-" + placement.ContainerID }>
								<div
									hx-get={ fmt.Sprintf("/web/containers/%s/logs?tail=100", placement.ContainerID) }
									hx-trigger="load"
									hx-swap="innerHTML">
									<div class="loading">Loading logs...</div>
								</div>
							</div>
						} else {
							<div class="log-content">
								<p class="text-muted">Container not yet created</p>
							</div>
						}
					</div>
				}
			}
		</div>
	}
}

// Create host form template
templ CreateHostFormWithUser(host *models.Host, errorMsg string, user *models.User) {
	@LayoutWithUser("Create Host", user) {
		<div class="page-header">
			<div>
				<h2>Register New Host</h2>
				<p>Add a new Docker host to your infrastructure</p>
			</div>
			<div class="page-actions">
				<a href="/web/hosts" class="btn btn-secondary">‚Üê Back to Hosts</a>
			</div>
		</div>
		if errorMsg != "" {
			<div class="alert alert-error">
				{ errorMsg }
			</div>
		}
		<div class="form-container">
			<form method="POST" action="/web/hosts/create" class="host-form">
				<div class="form-section">
					<h3>Host Information</h3>
					<div class="form-group">
						<label for="id">Host ID *</label>
						<input type="text" id="id" name="id" value={ host.ID } required placeholder="host-001"/>
						<small class="form-text">Unique identifier (e.g., host-001, web-server-01)</small>
					</div>
					<div class="form-group">
						<label for="name">Host Name *</label>
						<input type="text" id="name" name="name" value={ host.Name } required placeholder="localhost-docker"/>
						<small class="form-text">Friendly display name</small>
					</div>
					<div class="form-group">
						<label for="ipAddress">IP Address *</label>
						<input type="text" id="ipAddress" name="ipAddress" value={ host.IPAddress } required placeholder="localhost or 192.168.1.100"/>
						<small class="form-text">Use "localhost" for local Docker, or IP address for remote hosts</small>
					</div>
					<div class="form-group">
						<label for="datacenter">Datacenter / Location</label>
						<input type="text" id="datacenter" name="datacenter" value={ host.Datacenter } placeholder="us-west, europe, etc."/>
						<small class="form-text">Optional: Group hosts by location</small>
					</div>
				</div>
				<div class="form-section">
					<h3>Resources</h3>
					<div class="form-group">
						<label for="cpu">CPU Cores</label>
						<input type="number" id="cpu" name="cpu" value={ fmt.Sprintf("%d", host.CPU) } min="1" placeholder="4"/>
						<small class="form-text">Number of CPU cores available</small>
					</div>
					<div class="form-group">
						<label for="memory">Memory (bytes)</label>
						<input type="number" id="memory" name="memory" value={ fmt.Sprintf("%d", host.Memory) } min="0" placeholder="8589934592"/>
						<small class="form-text">Total memory in bytes (8589934592 = 8GB)</small>
					</div>
				</div>
				<div class="form-section">
					<h3>Status</h3>
					<div class="form-group">
						<label for="status">Status *</label>
						<select id="status" name="status" class="form-select" required>
							<option value="active" selected?={ host.Status == "active" }>Active - Ready for deployments</option>
							<option value="maintenance" selected?={ host.Status == "maintenance" }>Maintenance - Temporarily unavailable</option>
							<option value="offline" selected?={ host.Status == "offline" }>Offline - Not accessible</option>
						</select>
					</div>
				</div>
				<div class="alert alert-info">
					<strong>Docker Connection:</strong> Ensure Docker is running and accessible on this host.
					<ul style="margin: 10px 0 0 20px;">
						<li><strong>localhost</strong>: Will use unix:///var/run/docker.sock</li>
						<li><strong>Remote IP</strong>: Will use tcp://IP:2375 (ensure Docker API is exposed)</li>
					</ul>
				</div>
				<div class="form-actions">
					<button type="submit" class="btn btn-primary">Create Host</button>
					<a href="/web/hosts" class="btn btn-secondary">Cancel</a>
				</div>
			</form>
		</div>
	}
}

// Edit host form template
templ EditHostFormWithUser(host *models.Host, errorMsg string, user *models.User) {
	@LayoutWithUser("Edit Host", user) {
		<div class="page-header">
			<div>
				<a href={ templ.URL(fmt.Sprintf("/web/hosts/%s", host.ID)) } class="btn btn-secondary">‚Üê Back to Host</a>
				<h2>Edit Host: { host.Name }</h2>
			</div>
		</div>
		if errorMsg != "" {
			<div class="alert alert-error">
				{ errorMsg }
			</div>
		}
		<div class="form-container">
			<form method="POST" action={ templ.URL(fmt.Sprintf("/web/hosts/%s/update", host.ID)) } class="host-form">
				<div class="form-section">
					<h3>Host Information</h3>
					<div class="form-group">
						<label>Host ID</label>
						<input type="text" value={ host.ID } disabled/>
						<small class="form-text">Cannot be changed</small>
					</div>
					<div class="form-group">
						<label for="name">Host Name *</label>
						<input type="text" id="name" name="name" value={ host.Name } required/>
					</div>
					<div class="form-group">
						<label for="ipAddress">IP Address *</label>
						<input type="text" id="ipAddress" name="ipAddress" value={ host.IPAddress } required/>
						<small class="form-text">Use "localhost" for local, or IP for remote</small>
					</div>
					<div class="form-group">
						<label for="datacenter">Datacenter / Location</label>
						<input type="text" id="datacenter" name="datacenter" value={ host.Datacenter }/>
					</div>
				</div>
				<div class="form-section">
					<h3>Resources</h3>
					<div class="form-group">
						<label for="cpu">CPU Cores</label>
						<input type="number" id="cpu" name="cpu" value={ fmt.Sprintf("%d", host.CPU) } min="1"/>
					</div>
					<div class="form-group">
						<label for="memory">Memory (bytes)</label>
						<input type="number" id="memory" name="memory" value={ fmt.Sprintf("%d", host.Memory) } min="0"/>
					</div>
				</div>
				<div class="form-section">
					<h3>Status</h3>
					<div class="form-group">
						<label for="status">Status *</label>
						<select id="status" name="status" class="form-select" required>
							<option value="active" selected?={ host.Status == "active" }>Active</option>
							<option value="maintenance" selected?={ host.Status == "maintenance" }>Maintenance</option>
							<option value="offline" selected?={ host.Status == "offline" }>Offline</option>
						</select>
					</div>
				</div>
				<div class="form-actions">
					<button type="submit" class="btn btn-primary">Update Host</button>
					<a href={ templ.URL(fmt.Sprintf("/web/hosts/%s", host.ID)) } class="btn btn-secondary">Cancel</a>
				</div>
			</form>
		</div>
	}
}

// JSONLDDeployPage renders the JSON-LD stack deployment page
templ JSONLDDeployPage(user *models.User, validationResult *parseResultResponse, errorMsg string) {
	@LayoutWithUser("Deploy Stack (JSON-LD)", user) {
		<div class="container">
			<div class="page-header">
				<h1>Deploy Stack (JSON-LD)</h1>
				<p>Deploy containers using JSON-LD @graph format with semantic relationships</p>
			</div>
			if errorMsg != "" {
				<div class="alert alert-error">
					{ errorMsg }
				</div>
			}
			if validationResult != nil {
				if validationResult.Valid {
					<div class="alert alert-success">
						<strong>Validation Passed!</strong>
						<ul>
							<li>Stack: { validationResult.StackName }</li>
							<li>Containers: { fmt.Sprintf("%d", validationResult.ContainerCount) }</li>
							<li>Waves: { fmt.Sprintf("%d", validationResult.WaveCount) }</li>
							if validationResult.HasNetwork {
								<li>Custom network defined</li>
							}
						</ul>
						if len(validationResult.Warnings) > 0 {
							<strong>Warnings:</strong>
							<ul>
								for _, warning := range validationResult.Warnings {
									<li>{ warning }</li>
								}
							</ul>
						}
					</div>
				} else {
					<div class="alert alert-error">
						<strong>Validation Failed!</strong>
						<ul>
							for _, err := range validationResult.Errors {
								<li>{ err }</li>
							}
						</ul>
					</div>
				}
			}
			<div class="card">
				<form method="POST" action="/web/stacks/jsonld/deploy">
					<div class="form-group">
						<label for="stackDefinition">Stack Definition (JSON-LD)</label>
						<textarea
							id="stackDefinition"
							name="stackDefinition"
							rows="20"
							style="font-family: monospace; font-size: 12px;"
							placeholder='Paste your JSON-LD stack definition here'
							required
						></textarea>
					</div>
					<div class="form-group">
						<label for="timeout">Timeout (seconds)</label>
						<input type="number" id="timeout" name="timeout" value="300" min="30" max="3600"/>
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" name="rollbackOnError" checked/>
							Rollback on error
						</label>
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" name="pullImages"/>
							Pull images before deployment
						</label>
					</div>
					<div class="form-actions">
						<button type="button" class="btn btn-secondary" hx-post="/web/stacks/jsonld/validate" hx-include="[name='stackDefinition']" hx-target="#validation-result">
							Validate
						</button>
						<button type="submit" class="btn btn-primary">Deploy Stack</button>
						<a href="/web/stacks" class="btn btn-secondary">View Deployments</a>
					</div>
				</form>
				<div id="validation-result" style="margin-top: 20px;"></div>
			</div>
			<div class="card" style="margin-top: 20px;">
				<h3>Documentation</h3>
				<p>The JSON-LD format uses Schema.org vocabulary with custom datacenter extensions:</p>
				<ul>
					<li><strong>{ "@context" }</strong>: Must be "https://schema.org"</li>
					<li><strong>{ "@graph" }</strong>: Array of related entities</li>
					<li><strong>Stack</strong>: Root entity with hasPart array of containers</li>
					<li><strong>Container</strong>: Individual container specifications</li>
				</ul>
				<p>See the example in the editor above for complete structure.</p>
			</div>
		</div>
	}
}

// JSONLDDeploymentDetailPage renders detailed deployment information
templ JSONLDDeploymentDetailPage(deployment *deploymentStateResponse, user *models.User) {
	@LayoutWithUser("Deployment Details", user) {
		<div class="container">
			<div class="page-header">
				<div>
					<h1>Deployment: { deployment.StackID }</h1>
					<p>ID: { deployment.ID }</p>
				</div>
				<div style="display: flex; gap: 10px;">
					<a href={ templ.URL(fmt.Sprintf("/web/stacks/%s", deployment.StackID)) } class="btn btn-primary">Manage Stack</a>
					<a href="/web/stacks" class="btn btn-secondary">Back to List</a>
				</div>
			</div>
			<div class="card">
				<h2>Status</h2>
				<div class="deployment-status">
					<div class="status-item">
						<label>Status:</label>
						<span class={ "status", "status-" + deployment.Status }>{ deployment.Status }</span>
					</div>
					<div class="status-item">
						<label>Phase:</label>
						<span>{ deployment.Phase }</span>
					</div>
					<div class="status-item">
						<label>Progress:</label>
						<div class="progress-bar" style="width: 300px;">
							<div class="progress-fill" style={ fmt.Sprintf("width: %d%%", deployment.Progress) }></div>
						</div>
						{ fmt.Sprintf("%d%%", deployment.Progress) }
					</div>
					<div class="status-item">
						<label>Started:</label>
						<span>{ deployment.StartedAt.Format("2006-01-02 15:04:05") }</span>
					</div>
					if deployment.CompletedAt != nil {
						<div class="status-item">
							<label>Completed:</label>
							<span>{ deployment.CompletedAt.Format("2006-01-02 15:04:05") }</span>
						</div>
					}
					if deployment.ErrorMessage != "" {
						<div class="alert alert-error">
							<strong>Error:</strong> { deployment.ErrorMessage }
						</div>
					}
				</div>
			</div>
			if len(deployment.Placements) > 0 {
				<div class="card">
					<h2>Container Placements</h2>
					<table>
						<thead>
							<tr>
								<th>Container</th>
								<th>Host</th>
								<th>Container ID</th>
								<th>Status</th>
							</tr>
						</thead>
						<tbody>
							for containerName, placement := range deployment.Placements {
								<tr>
									<td>{ containerName }</td>
									<td>{ placement.HostID }</td>
									<td>
										if placement.ContainerID != "" {
											<code>{ placement.ContainerID[:12] }</code>
										} else {
											<em>Not created</em>
										}
									</td>
									<td>
										<span class={ "status", "status-" + placement.Status }>{ placement.Status }</span>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			}
			if deployment.NetworkInfo != nil {
				<div class="card">
					<h2>Network Information</h2>
					<div class="info-grid">
						<div class="info-item">
							<label>Network Name:</label>
							<span>{ deployment.NetworkInfo.NetworkName }</span>
						</div>
						<div class="info-item">
							<label>Network ID:</label>
							<span><code>{ deployment.NetworkInfo.NetworkID[:12] }</code></span>
						</div>
						<div class="info-item">
							<label>Driver:</label>
							<span>{ deployment.NetworkInfo.Driver }</span>
						</div>
					</div>
				</div>
			}
			if len(deployment.Events) > 0 {
				<div class="card">
					<h2>Deployment Events</h2>
					<div class="events-list">
						for _, event := range deployment.Events {
							<div class={ "event", "event-" + event.Type }>
								<div class="event-header">
									<span class="event-time">{ event.Timestamp.Format("15:04:05") }</span>
									<span class={ "event-level", "level-" + event.Type }>{ event.Type }</span>
									<span class="event-phase">{ event.Phase }</span>
								</div>
								<div class="event-body">
									if event.Container != "" {
										<strong>{ event.Container }:</strong>
									}
									{ event.Message }
								</div>
							</div>
						}
					</div>
				</div>
			}
			if deployment.RollbackState != nil {
				<div class="card">
					<h2>Rollback Information</h2>
					<div class="alert alert-warning">
						<p><strong>Rollback { deployment.RollbackState.Status }</strong></p>
						<p>Started: { deployment.RollbackState.StartedAt.Format("2006-01-02 15:04:05") }</p>
						if deployment.RollbackState.CompletedAt != nil {
							<p>Completed: { deployment.RollbackState.CompletedAt.Format("2006-01-02 15:04:05") }</p>
						}
						if len(deployment.RollbackState.RemovedContainers) > 0 {
							<p>Removed containers:</p>
							<ul>
								for _, containerName := range deployment.RollbackState.RemovedContainers {
									<li>{ containerName }</li>
								}
							</ul>
						}
						if deployment.RollbackState.ErrorMessage != "" {
							<p><strong>Error:</strong> { deployment.RollbackState.ErrorMessage }</p>
						}
					</div>
				</div>
			}
		</div>
	}
}

// ============================================================================
// AGENTS TEMPLATES
// ============================================================================

// Agent list page with user
templ AgentsListWithUser(agents []AgentInfo, user *models.User) {
	@LayoutWithUser("Agents", user) {
		<div class="page-header">
			<h2>Agents</h2>
			<div class="filters">
				<input
					type="text"
					name="search"
					class="search-input"
					placeholder="Search by name or host..."
					hx-get="/web/agents/table"
					hx-target="#agents-table"
					hx-trigger="keyup changed delay:300ms"
					hx-include="[name='status']"
				/>
				<select name="status" hx-get="/web/agents/table" hx-target="#agents-table" hx-trigger="change" hx-include="[name='search']">
					<option value="">All Statuses</option>
					<option value="running">Running</option>
					<option value="stopped">Stopped</option>
					<option value="failed">Failed</option>
				</select>
				<a href="/web/agents/new" class="btn btn-primary">+ Create Agent</a>
			</div>
		</div>

		<div id="agents-table">
			@AgentsTable(agents)
		</div>
	}
}

// AgentInfo combines config and state for display
type AgentInfo struct {
	Config *models.AgentConfig
	State  *models.AgentState
}

// Agents table component (for HTMX updates)
templ AgentsTable(agents []AgentInfo) {
	<div class="table-container">
		<table class="data-table">
			<thead>
				<tr>
					<th>Name</th>
					<th>Host ID</th>
					<th>Docker Socket</th>
					<th>Status</th>
					<th>Containers</th>
					<th>Last Heartbeat</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				if len(agents) == 0 {
					<tr>
						<td colspan="7" class="no-data">No agents found</td>
					</tr>
				}
				for _, agent := range agents {
					<tr>
						<td>
							<strong>{ agent.Config.Name }</strong>
							<br/>
							<small class="text-muted">{ agent.Config.ID }</small>
						</td>
						<td>{ agent.Config.HostID }</td>
						<td>
							<span class="text-muted">{ agent.Config.DockerSocket }</span>
						</td>
						<td>
							<span class={ fmt.Sprintf("badge badge-%s", getAgentStatusClass(agent.State.Status)) }>
								{ agent.State.Status }
							</span>
						</td>
						<td>{ fmt.Sprintf("%d", agent.State.ContainerCount) }</td>
						<td>
							if agent.State.LastHeartbeat != nil {
								<span class="text-muted">{ formatTimeAgo(*agent.State.LastHeartbeat) }</span>
							} else {
								<span class="text-muted">Never</span>
							}
						</td>
						<td>
							<div class="action-buttons">
								if agent.State.Status == "running" {
									<button
										class="btn-icon"
										title="Stop Agent"
										hx-post={ fmt.Sprintf("/web/agents/%s/stop", agent.Config.ID) }
										hx-target="#agents-table"
										hx-swap="outerHTML"
									>‚è∏Ô∏è</button>
									<button
										class="btn-icon"
										title="Restart Agent"
										hx-post={ fmt.Sprintf("/web/agents/%s/restart", agent.Config.ID) }
										hx-target="#agents-table"
										hx-swap="outerHTML"
									>üîÑ</button>
								} else {
									<button
										class="btn-icon"
										title="Start Agent"
										hx-post={ fmt.Sprintf("/web/agents/%s/start", agent.Config.ID) }
										hx-target="#agents-table"
										hx-swap="outerHTML"
									>‚ñ∂Ô∏è</button>
								}
								<a href={ templ.URL(fmt.Sprintf("/web/agents/%s", agent.Config.ID)) } class="btn-icon" title="View Details">üëÅÔ∏è</a>
								<button
									class="btn-icon btn-danger"
									title="Delete Agent"
									hx-delete={ fmt.Sprintf("/web/agents/%s", agent.Config.ID) }
									hx-target="#agents-table"
									hx-swap="outerHTML"
									hx-confirm="Are you sure you want to delete this agent?"
								>üóëÔ∏è</button>
							</div>
						</td>
					</tr>
				}
			</tbody>
		</table>
		<div class="table-footer">
			<p>Total: { fmt.Sprintf("%d", len(agents)) } agents</p>
		</div>
	</div>
}

// Agent detail page with user
templ AgentDetailWithUser(agent AgentInfo, user *models.User) {
	@LayoutWithUser(fmt.Sprintf("Agent: %s", agent.Config.Name), user) {
		<div class="page-header">
			<h2>Agent: { agent.Config.Name }</h2>
			<div class="flex-row" style="gap: 0.5rem; align-items: center;">
				<a href="/web/agents" class="btn btn-secondary">‚Üê Back to Agents</a>
				if agent.State.Status == "running" {
					<button
						class="btn btn-warning"
						hx-post={ fmt.Sprintf("/web/agents/%s/stop", agent.Config.ID) }
						hx-target="body"
						hx-swap="outerHTML"
					>‚è∏Ô∏è Stop Agent</button>
					<button
						class="btn btn-primary"
						hx-post={ fmt.Sprintf("/web/agents/%s/restart", agent.Config.ID) }
						hx-target="body"
						hx-swap="outerHTML"
					>üîÑ Restart Agent</button>
				} else {
					<button
						class="btn btn-success"
						hx-post={ fmt.Sprintf("/web/agents/%s/start", agent.Config.ID) }
						hx-target="body"
						hx-swap="outerHTML"
					>‚ñ∂Ô∏è Start Agent</button>
				}
				<button
					class="btn btn-danger"
					hx-delete={ fmt.Sprintf("/web/agents/%s", agent.Config.ID) }
					hx-confirm="Are you sure you want to delete this agent? This action cannot be undone."
					hx-target="body"
					hx-swap="outerHTML"
				>üóëÔ∏è Delete Agent</button>
			</div>
		</div>

		<div class="detail-grid">
			<div class="detail-card">
				<h3>Configuration</h3>
				<div class="detail-row">
					<span class="detail-label">ID:</span>
					<span class="detail-value">{ agent.Config.ID }</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Name:</span>
					<span class="detail-value">{ agent.Config.Name }</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Host ID:</span>
					<span class="detail-value">{ agent.Config.HostID }</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Docker Socket:</span>
					<span class="detail-value">{ agent.Config.DockerSocket }</span>
				</div>
			<div class="detail-row">
				<span class="detail-label">SSH Key Path:</span>
				<span class="detail-value">
					if agent.Config.SSHKeyPath != "" {
						{ agent.Config.SSHKeyPath }
					} else {
						<span class="text-muted">Not configured</span>
					}
				</span>
			</div>
				<div class="detail-row">
					<span class="detail-label">Datacenter:</span>
					<span class="detail-value">{ agent.Config.Datacenter }</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Sync Interval:</span>
					<span class="detail-value">{ fmt.Sprintf("%d seconds", agent.Config.SyncInterval) }</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Enabled:</span>
					<span class="detail-value">
						if agent.Config.Enabled {
							<span class="badge badge-success">Yes</span>
						} else {
							<span class="badge badge-secondary">No</span>
						}
					</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Auto Start:</span>
					<span class="detail-value">
						if agent.Config.AutoStart {
							<span class="badge badge-success">Yes</span>
						} else {
							<span class="badge badge-secondary">No</span>
						}
					</span>
				</div>
			</div>

			<div class="detail-card">
				<h3>Runtime State</h3>
				<div class="detail-row">
					<span class="detail-label">Status:</span>
					<span class="detail-value">
						<span class={ fmt.Sprintf("badge badge-%s", getAgentStatusClass(agent.State.Status)) }>
							{ agent.State.Status }
						</span>
					</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Process ID:</span>
					<span class="detail-value">
						if agent.State.ProcessID > 0 {
							{ fmt.Sprintf("%d", agent.State.ProcessID) }
						} else {
							<span class="text-muted">N/A</span>
						}
					</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Container Count:</span>
					<span class="detail-value">{ fmt.Sprintf("%d", agent.State.ContainerCount) }</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Started At:</span>
					<span class="detail-value">
						if agent.State.StartedAt != nil {
							{ agent.State.StartedAt.Format("2006-01-02 15:04:05") }
						} else {
							<span class="text-muted">N/A</span>
						}
					</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Last Heartbeat:</span>
					<span class="detail-value">
						if agent.State.LastHeartbeat != nil {
							{ agent.State.LastHeartbeat.Format("2006-01-02 15:04:05") }
							<small class="text-muted">({ formatTimeAgo(*agent.State.LastHeartbeat) })</small>
						} else {
							<span class="text-muted">Never</span>
						}
					</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Last Sync:</span>
					<span class="detail-value">
						if agent.State.LastSyncAt != nil {
							{ agent.State.LastSyncAt.Format("2006-01-02 15:04:05") }
						} else {
							<span class="text-muted">Never</span>
						}
					</span>
				</div>
				if agent.State.ErrorMessage != "" {
					<div class="detail-row">
						<span class="detail-label">Error:</span>
						<span class="detail-value text-danger">{ agent.State.ErrorMessage }</span>
					</div>
				}
			</div>
		</div>

		<!-- Agent Logs -->
		<div class="detail-card" style="margin-top: 2rem;">
			<div class="flex-row" style="align-items: center; margin-bottom: 1rem;">
				<h3 style="margin: 0;">Agent Logs</h3>
				<div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
					<label for="log-lines-agent" style="margin: 0; font-size: 0.9rem;">Lines:</label>
					<select id="log-lines-agent" class="form-control" style="width: auto; padding: 0.25rem 0.5rem;">
						<option value="100">100</option>
						<option value="500">500</option>
						<option value="1000" selected>1000</option>
						<option value="5000">5000</option>
					</select>
					<a
						href={ templ.URL(fmt.Sprintf("/web/agents/%s/logs/download?lines=1000", agent.Config.ID)) }
						class="btn btn-secondary"
						download
						style="padding: 0.25rem 0.75rem; font-size: 0.9rem;"
					>üì• Download</a>
				</div>
			</div>

			<div
				id="logs-container-agent"
				style="background: #1a1a1a; color: #00ff00; padding: 1rem; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.85rem; max-height: 600px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"
			>
				<div
					hx-get={ fmt.Sprintf("/web/agents/%s/logs?tail=1000", agent.Config.ID) }
					hx-trigger="load, every 5s"
					hx-swap="innerHTML"
				>
					Loading logs...
				</div>
			</div>
		</div>

		<script>
			// Update logs when line count changes
			document.getElementById('log-lines-agent').addEventListener('change', function(e) {
				const lines = e.target.value;
				const agentID = "{ agent.Config.ID }";
				htmx.ajax('GET', `/web/agents/${agentID}/logs?tail=${lines}`, {
					target: '#logs-container-agent > div',
					swap: 'innerHTML'
				});
				// Update download link
				document.querySelector('a[download]').href = `/web/agents/${agentID}/logs/download?lines=${lines}`;
			});
		</script>
	}
}

// Create agent form page
templ CreateAgentFormWithUser(errorMsg string, user *models.User) {
	@LayoutWithUser("Create Agent", user) {
		<div class="page-header">
			<h2>Create New Agent</h2>
			<div class="flex-row">
				<a href="/web/agents" class="btn btn-secondary">‚Üê Back to Agents</a>
			</div>
		</div>

		if errorMsg != "" {
			<div class="alert alert-danger">{ errorMsg }</div>
		}

		<div class="form-container">
			<form method="POST" action="/web/agents/create">
				<div class="form-group">
					<label for="name">Agent Name *</label>
					<input
						type="text"
						id="name"
						name="name"
						required
						placeholder="e.g., production-docker-1"
					/>
				</div>

				<div class="form-group">
					<label for="hostid">Host ID *</label>
					<input
						type="text"
						id="hostid"
						name="hostid"
						required
						placeholder="e.g., prod-host-01"
					/>
					<small class="form-help">Unique identifier for the host this agent monitors</small>
				</div>

				<div class="form-group">
					<label for="docker_socket">Docker Socket</label>
					<input
						type="text"
						id="docker_socket"
						name="docker_socket"
						value="/var/run/docker.sock"
					/>
					<small class="form-help">
						Docker daemon connection. Examples:<br/>
						‚Ä¢ Unix socket: <code>unix:///var/run/docker.sock</code> or <code>/var/run/docker.sock</code><br/>
						‚Ä¢ TCP: <code>tcp://192.168.1.10:2375</code> (unencrypted) or <code>tcp://192.168.1.10:2376</code> (TLS)<br/>
						‚Ä¢ SSH: <code>ssh://user@hostname</code> or <code>ssh://user@hostname:22</code><br/>
						‚Ä¢ Named pipe (Windows): <code>npipe:////./pipe/docker_engine</code>
					</small>
				</div>

				<div class="form-group">
					<label for="ssh_key_path">SSH Key Path (Optional)</label>
					<input
						type="text"
						id="ssh_key_path"
						name="ssh_key_path"
						placeholder="e.g., /home/user/.ssh/id_rsa"
					/>
					<small class="form-help">
						Path to SSH private key for remote Docker connections (ssh://user@host).<br/>
						Required when using SSH docker socket without ssh-agent.
					</small>
				</div>

				<div class="form-group">
					<label for="datacenter">Datacenter</label>
					<input
						type="text"
						id="datacenter"
						name="datacenter"
						placeholder="e.g., us-west-1"
					/>
					<small class="form-help">Optional datacenter location</small>
				</div>

				<div class="form-group">
					<label for="sync_interval">Sync Interval (seconds)</label>
					<input
						type="number"
						id="sync_interval"
						name="sync_interval"
						value="30"
						min="10"
						max="3600"
					/>
					<small class="form-help">How often to sync container state (default: 30 seconds)</small>
				</div>

				<div class="form-group">
					<label class="checkbox-label">
						<input
							type="checkbox"
							name="enabled"
							value="true"
							checked
						/>
						<span>Enable agent on creation</span>
					</label>
					<small class="form-help">If enabled, agent will start automatically</small>
				</div>

				<div class="form-group">
					<label class="checkbox-label">
						<input
							type="checkbox"
							name="auto_start"
							value="true"
							checked
						/>
						<span>Auto-start on server restart</span>
					</label>
					<small class="form-help">Agent will start automatically when Graphium server starts</small>
				</div>

				<div class="form-actions">
					<button type="submit" class="btn btn-primary">Create Agent</button>
					<a href="/web/agents" class="btn btn-secondary">Cancel</a>
				</div>
			</form>
		</div>
	}
}

// Helper function to get CSS class for agent status
func getAgentStatusClass(status string) string {
	switch status {
	case "running":
		return "success"
	case "stopped":
		return "secondary"
	case "failed":
		return "danger"
	case "starting":
		return "warning"
	case "stopping":
		return "warning"
	default:
		return "secondary"
	}
}

// Helper function to format time ago
func formatTimeAgo(t time.Time) string {
	duration := time.Since(t)

	if duration < time.Minute {
		return "just now"
	}
	if duration < time.Hour {
		minutes := int(duration.Minutes())
		if minutes == 1 {
			return "1 minute ago"
		}
		return fmt.Sprintf("%d minutes ago", minutes)
	}
	if duration < 24*time.Hour {
		hours := int(duration.Hours())
		if hours == 1 {
			return "1 hour ago"
		}
		return fmt.Sprintf("%d hours ago", hours)
	}
	days := int(duration.Hours() / 24)
	if days == 1 {
		return "1 day ago"
	}
	return fmt.Sprintf("%d days ago", days)
}

// ============================================================================
// SCHEDULED ACTIONS TEMPLATES  
// ============================================================================

// Actions list page with user
templ ActionsListWithUser(actions []*models.ScheduledAction, user *models.User) {
	@LayoutWithUser("Scheduled Actions", user) {
		<div class="page-header">
			<h2>Scheduled Actions</h2>
			<div class="filters">
				<input
					type="text"
					name="search"
					class="search-input"
					placeholder="Search by name..."
					hx-get="/web/actions/table"
					hx-target="#actions-table"
					hx-trigger="keyup changed delay:300ms"
					hx-include="[name='status']"
				/>
				<select name="status" hx-get="/web/actions/table" hx-target="#actions-table" hx-trigger="change" hx-include="[name='search']">
					<option value="">All Actions</option>
					<option value="enabled">Enabled</option>
					<option value="disabled">Disabled</option>
				</select>
				<a href="/web/actions/new" class="btn btn-primary">+ Create Action</a>
			</div>
		</div>

		<div id="actions-table">
			@ActionsTable(actions)
		</div>
	}
}

// Actions table component (for HTMX updates)
templ ActionsTable(actions []*models.ScheduledAction) {
	<div class="table-container">
		<table class="data-table">
			<thead>
				<tr>
					<th>Name</th>
					<th>Type</th>
					<th>Agent</th>
					<th>Schedule</th>
					<th>Status</th>
					<th>Last Run</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				if len(actions) == 0 {
					<tr>
						<td colspan="7" class="no-data">No scheduled actions found</td>
					</tr>
				}
				for _, action := range actions {
					<tr>
						<td>
							<strong>{ action.Name }</strong>
							if action.Description != "" {
								<br/><small class="text-muted">{ action.Description }</small>
							}
						</td>
						<td>{ action.Type }</td>
						<td>{ action.Agent }</td>
						<td>
							if action.Schedule != nil {
								<span class="text-muted">{ action.Schedule.RepeatFrequency }</span>
							}
						</td>
						<td>
							<span class={ fmt.Sprintf("badge badge-%s", map[bool]string{true: "success", false: "secondary"}[action.Enabled]) }>
								if action.Enabled {
									Enabled
								} else {
									Disabled
								}
							</span>
						</td>
						<td>
							if action.StartTime != nil {
								<span class="text-muted">{ formatTimeAgo(*action.StartTime) }</span>
							} else {
								<span class="text-muted">Never</span>
							}
						</td>
						<td>
							<div class="action-buttons">
								<a href={ templ.URL(fmt.Sprintf("/web/actions/%s", action.ID)) } class="btn-icon" title="View Details">üëÅÔ∏è</a>
								<button
									class="btn-icon"
									title="Execute Now"
									hx-post={ fmt.Sprintf("/api/v1/actions/%s/execute", action.ID) }
									hx-swap="none"
								>‚ñ∂Ô∏è</button>
								<button
									class="btn-icon btn-danger"
									title="Delete"
									hx-delete={ fmt.Sprintf("/api/v1/actions/%s", action.ID) }
									hx-target="#actions-table"
									hx-swap="outerHTML"
									hx-confirm="Are you sure you want to delete this action?"
								>üóëÔ∏è</button>
							</div>
						</td>
					</tr>
				}
			</tbody>
		</table>
		<div class="table-footer">
			<p>Total: { fmt.Sprintf("%d", len(actions)) } actions</p>
		</div>
	</div>
}

// Action detail page
templ ActionDetailWithUser(action *models.ScheduledAction, tasks []*models.AgentTask, user *models.User) {
	@LayoutWithUser(fmt.Sprintf("Action: %s", action.Name), user) {
		<div class="page-header">
			<h2>{ action.Name }</h2>
			<div class="flex-row" style="gap: 0.5rem;">
				<a href="/web/actions" class="btn btn-secondary">‚Üê Back to Actions</a>
				<button
					class="btn btn-primary"
					hx-post={ fmt.Sprintf("/api/v1/actions/%s/execute", action.ID) }
					hx-swap="none"
				>‚ñ∂Ô∏è Execute Now</button>
				<button
					class="btn btn-danger"
					hx-delete={ fmt.Sprintf("/api/v1/actions/%s", action.ID) }
					hx-confirm="Are you sure you want to delete this action?"
					hx-target="body"
					hx-swap="outerHTML"
				>üóëÔ∏è Delete</button>
			</div>
		</div>

		<div class="detail-grid">
			<div class="detail-card">
				<h3>Configuration</h3>
				<div class="detail-row">
					<span class="detail-label">Name:</span>
					<span class="detail-value">{ action.Name }</span>
				</div>
				if action.Description != "" {
					<div class="detail-row">
						<span class="detail-label">Description:</span>
						<span class="detail-value">{ action.Description }</span>
					</div>
				}
				<div class="detail-row">
					<span class="detail-label">Type:</span>
					<span class="detail-value">{ action.Type }</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Agent:</span>
					<span class="detail-value">{ action.Agent }</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Status:</span>
					<span class="detail-value">
						<span class={ fmt.Sprintf("badge badge-%s", map[bool]string{true: "success", false: "secondary"}[action.Enabled]) }>
							if action.Enabled {
								Enabled
							} else {
								Disabled
							}
						</span>
					</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">Action Status:</span>
					<span class="detail-value">{ action.ActionStatus }</span>
				</div>
			</div>

			<div class="detail-card">
				<h3>Schedule</h3>
				if action.Schedule != nil {
					<div class="detail-row">
						<span class="detail-label">Frequency:</span>
						<span class="detail-value">{ action.Schedule.RepeatFrequency }</span>
					</div>
					if action.Schedule.ScheduleTimezone != "" {
						<div class="detail-row">
							<span class="detail-label">Timezone:</span>
							<span class="detail-value">{ action.Schedule.ScheduleTimezone }</span>
						</div>
					}
					if action.Schedule.StartDate != nil {
						<div class="detail-row">
							<span class="detail-label">Start Date:</span>
							<span class="detail-value">{ action.Schedule.StartDate.Format("2006-01-02 15:04:05") }</span>
						</div>
					}
					if action.Schedule.EndDate != nil {
						<div class="detail-row">
							<span class="detail-label">End Date:</span>
							<span class="detail-value">{ action.Schedule.EndDate.Format("2006-01-02 15:04:05") }</span>
						</div>
					}
				}
			</div>
		</div>

		<div class="detail-card" style="margin-top: 2rem;">
			<h3>Execution History</h3>
			if len(tasks) == 0 {
				<p class="text-muted">No executions yet</p>
			} else {
				<table class="data-table">
					<thead>
						<tr>
							<th>Task ID</th>
							<th>Status</th>
							<th>Created</th>
							<th>Completed</th>
							<th>Duration</th>
						</tr>
					</thead>
					<tbody>
						for _, task := range tasks {
							<tr>
								<td><code>{ task.ID[:16] }...</code></td>
								<td>
									<span class={ fmt.Sprintf("badge badge-%s", task.Status) }>
										{ task.Status }
									</span>
								</td>
								<td>{ task.CreatedAt.Format("2006-01-02 15:04") }</td>
								<td>
									if task.CompletedAt != nil {
										{ task.CompletedAt.Format("2006-01-02 15:04") }
									} else {
										<span class="text-muted">-</span>
									}
								</td>
								<td>
									if task.CompletedAt != nil && task.StartedAt != nil {
										{ fmt.Sprintf("%.1fs", task.CompletedAt.Sub(*task.StartedAt).Seconds()) }
									} else {
										<span class="text-muted">-</span>
									}
								</td>
							</tr>
						}
					</tbody>
				</table>
			}
		</div>
	}
}

// Create action form
templ CreateActionFormWithUser(errorMsg string, user *models.User) {
	@LayoutWithUser("Create Scheduled Action", user) {
		<div class="page-header">
			<h2>Create Scheduled Action</h2>
			<div class="flex-row">
				<a href="/web/actions" class="btn btn-secondary">‚Üê Back to Actions</a>
			</div>
		</div>

		if errorMsg != "" {
			<div class="alert alert-danger">{ errorMsg }</div>
		}

		<div class="form-container">
			<form method="POST" action="/web/actions/create">
				<div class="form-section">
					<h3>Basic Information</h3>
					<div class="form-group">
						<label for="name">Name *</label>
						<input
							type="text"
							id="name"
							name="name"
							required
							placeholder="e.g., Nginx Health Check"
						/>
					</div>

					<div class="form-group">
						<label for="description">Description</label>
						<textarea
							id="description"
							name="description"
							rows="3"
							placeholder="Describe what this action does..."
						></textarea>
					</div>

					<div class="form-group">
						<label for="type">Action Type *</label>
						<select id="type" name="type" class="form-select" required>
							<option value="CheckAction">CheckAction - Health checks, probes</option>
							<option value="ControlAction">ControlAction - Start/stop operations</option>
							<option value="CreateAction">CreateAction - Create resources</option>
							<option value="UpdateAction">UpdateAction - Update existing resources</option>
							<option value="TransferAction">TransferAction - Data transfers</option>
						</select>
					</div>

					<div class="form-group">
						<label for="agent">Target Agent/Host *</label>
						<input
							type="text"
							id="agent"
							name="agent"
							required
							placeholder="e.g., localhost-docker or host:vm1"
						/>
						<small class="form-help">Agent ID or Host ID that will execute this action</small>
					</div>
				</div>

				<div class="form-section">
					<h3>Schedule</h3>
					<div class="form-group">
						<label for="repeat_frequency">Repeat Frequency *</label>
						<select id="repeat_frequency" name="repeat_frequency" class="form-select" required>
							<option value="PT5M">Every 5 minutes</option>
							<option value="PT15M">Every 15 minutes</option>
							<option value="PT30M">Every 30 minutes</option>
							<option value="PT1H">Every hour</option>
							<option value="PT6H">Every 6 hours</option>
							<option value="P1D">Daily</option>
							<option value="P1W">Weekly</option>
							<option value="custom">Custom (ISO 8601)</option>
						</select>
					</div>

					<div class="form-group" id="custom-frequency" style="display: none;">
						<label for="custom_frequency">Custom Frequency</label>
						<input
							type="text"
							id="custom_frequency"
							name="custom_frequency"
							placeholder="e.g., PT10M or P2D"
						/>
						<small class="form-help">ISO 8601 duration format (PT5M = 5 minutes, P1D = 1 day)</small>
					</div>

					<div class="form-group">
						<label for="timezone">Timezone</label>
						<input
							type="text"
							id="timezone"
							name="timezone"
							value="UTC"
							placeholder="e.g., UTC, America/New_York"
						/>
					</div>
				</div>

				<div class="form-section">
					<h3>Action Parameters</h3>
					<div class="form-group">
						<label for="url">URL (for CheckAction) *</label>
						<input
							type="url"
							id="url"
							name="url"
							placeholder="http://localhost:8080/health"
						/>
					</div>

					<div class="form-group">
						<label for="method">HTTP Method</label>
						<select id="method" name="method" class="form-select">
							<option value="GET">GET</option>
							<option value="POST">POST</option>
							<option value="HEAD">HEAD</option>
						</select>
					</div>

					<div class="form-group">
						<label for="expected_status">Expected Status Code</label>
						<input
							type="number"
							id="expected_status"
							name="expected_status"
							value="200"
							min="100"
							max="599"
						/>
					</div>

					<div class="form-group">
						<label for="timeout">Timeout (seconds)</label>
						<input
							type="number"
							id="timeout"
							name="timeout"
							value="5"
							min="1"
							max="60"
						/>
					</div>
				</div>

				<div class="form-section">
					<h3>Options</h3>
					<div class="form-group">
						<label class="checkbox-label">
							<input
								type="checkbox"
								name="enabled"
								value="true"
								checked
							/>
							<span>Enable on creation</span>
						</label>
					</div>
				</div>

				<div class="form-actions">
					<button type="submit" class="btn btn-primary">Create Action</button>
					<a href="/web/actions" class="btn btn-secondary">Cancel</a>
				</div>
			</form>
		</div>

		<script>
			document.getElementById('repeat_frequency').addEventListener('change', function(e) {
				const customDiv = document.getElementById('custom-frequency');
				if (e.target.value === 'custom') {
					customDiv.style.display = 'block';
				} else {
					customDiv.style.display = 'none';
				}
			});
		</script>
	}
}
